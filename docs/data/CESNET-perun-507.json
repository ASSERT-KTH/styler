{
    "project_name": "CESNET-perun",
    "error_id": "507",
    "information": {
        "errors": [
            {
                "line": "143",
                "severity": "error",
                "message": "Line matches the illegal pattern 'Wrong number of tabs before space on next line. Indent must use tab characters.'.",
                "source": "com.puppycrawl.tools.checkstyle.checks.regexp.RegexpCheck"
            }
        ]
    },
    "source_code": "\t\t\t\t// Get service users for user\n\t\t\t\tList<Integer> authzServiceUsers = jdbc.query(\"select specific_user_users.specific_user_id as id from users, \" +\n\t\t\t\t\t\t\"specific_user_users where users.id=specific_user_users.user_id and specific_user_users.status='0' and users.id=? \" +\n\t\t\t\t        \"and specific_user_users.type=?\", Utils.ID_MAPPER ,user.getId(), SpecificUserType.SERVICE.getSpecificUserType());\n\t\t\t\tfor (Integer serviceUserId : authzServiceUsers) {\n\t\t\t\t\tauthzRoles.putAuthzRole(Role.SELF, User.class, serviceUserId);",
    "results": [
        {
            "tool": "styler",
            "errors": [],
            "diff": "diff --git a/home/fernanda/mnt/fernanda/git-styler/styler/python/experiments/results/CESNET-perun/errored/1/507/AuthzResolverImpl.java b/home/fernanda/mnt/fernanda/git-styler/styler/python/experiments/results/CESNET-perun/styler/507/AuthzResolverImpl.java\nindex ca195b2458a..40d1612aeee 100644\n--- a/home/fernanda/mnt/fernanda/git-styler/styler/python/experiments/results/CESNET-perun/errored/1/507/AuthzResolverImpl.java\n+++ b/home/fernanda/mnt/fernanda/git-styler/styler/python/experiments/results/CESNET-perun/styler/507/AuthzResolverImpl.java\n@@ -141,7 +141,7 @@ public class AuthzResolverImpl implements AuthzResolverImplApi {\n \t\t\t\t// Get service users for user\n \t\t\t\tList<Integer> authzServiceUsers = jdbc.query(\"select specific_user_users.specific_user_id as id from users, \" +\n \t\t\t\t\t\t\"specific_user_users where users.id=specific_user_users.user_id and specific_user_users.status='0' and users.id=? \" +\n-\t\t\t\t        \"and specific_user_users.type=?\", Utils.ID_MAPPER ,user.getId(), SpecificUserType.SERVICE.getSpecificUserType());\n+\t\t\t\t\t\t\t\t\"and specific_user_users.type=?\", Utils.ID_MAPPER ,user.getId(), SpecificUserType.SERVICE.getSpecificUserType());\n \t\t\t\tfor (Integer serviceUserId : authzServiceUsers) {\n \t\t\t\t\tauthzRoles.putAuthzRole(Role.SELF, User.class, serviceUserId);\n \t\t\t\t}\n",
            "diff_size": 1
        },
        {
            "tool": "intellij",
            "errors": [],
            "diff": "diff --git a/home/fernanda/mnt/fernanda/git-styler/styler/python/experiments/results/CESNET-perun/errored/1/507/AuthzResolverImpl.java b/home/fernanda/mnt/fernanda/git-styler/styler/python/experiments/results/CESNET-perun/intellij/507/AuthzResolverImpl.java\nindex ca195b2458a..49314ccbdf6 100644\n--- a/home/fernanda/mnt/fernanda/git-styler/styler/python/experiments/results/CESNET-perun/errored/1/507/AuthzResolverImpl.java\n+++ b/home/fernanda/mnt/fernanda/git-styler/styler/python/experiments/results/CESNET-perun/intellij/507/AuthzResolverImpl.java\n@@ -4,6 +4,7 @@ import cz.metacentrum.perun.core.api.ActionType;\n import cz.metacentrum.perun.core.api.AttributeDefinition;\n import cz.metacentrum.perun.core.api.Facility;\n import cz.metacentrum.perun.core.api.Group;\n+\n import java.sql.ResultSet;\n import java.sql.SQLException;\n import java.util.ArrayList;\n@@ -37,555 +38,559 @@ import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n import cz.metacentrum.perun.core.api.exceptions.UserNotAdminException;\n import cz.metacentrum.perun.core.api.exceptions.rt.InternalErrorRuntimeException;\n import cz.metacentrum.perun.core.implApi.AuthzResolverImplApi;\n+\n import java.util.HashSet;\n import java.util.Set;\n+\n import org.springframework.dao.DataIntegrityViolationException;\n import org.springframework.dao.EmptyResultDataAccessException;\n \n public class AuthzResolverImpl implements AuthzResolverImplApi {\n \n-\tfinal static Logger log = LoggerFactory.getLogger(FacilitiesManagerImpl.class);\n-\n-\t//http://static.springsource.org/spring/docs/3.0.x/spring-framework-reference/html/jdbc.html\n-\tprivate static JdbcPerunTemplate jdbc;\n-\n-\tprivate Perun perun;\n-\tprivate final static Pattern patternForExtractingPerunBean = Pattern.compile(\"^pb_([a-z_]+)_id$\");\n-\n-\tpublic final static String authzRoleMappingSelectQuery = \" authz.user_id as authz_user_id, authz.role_id as authz_role_id,\" +\n-\t\t\"authz.authorized_group_id as authz_authorized_group_id, authz.vo_id as pb_vo_id, authz.group_id as pb_group_id, \" +\n-\t\t\"authz.facility_id as pb_facility_id, authz.member_id as pb_member_id, authz.resource_id as pb_resource_id, \" +\n-\t\t\"authz.service_id as pb_service_id, authz.service_principal_id as pb_user_id, authz.security_team_id as pb_security_team_id, \" +\n-\t\t\"authz.sponsored_user_id as pb_sponsored_user_id\";\n-\n-\n-\tprotected static final RowMapper<Role> AUTHZROLE_MAPPER_FOR_ATTRIBUTES = new RowMapper<Role>() {\n-\t\tpublic Role mapRow(ResultSet rs, int i) throws SQLException {\n-\t\t\tRole role = Role.valueOf(rs.getString(\"name\").toUpperCase());\n-\t\t\treturn role;\n-\t\t}\n-\t};\n-\n-\tpublic static final RowMapper<Pair<Role, Map<String, Set<Integer>>>> AUTHZROLE_MAPPER = new RowMapper<Pair<Role, Map<String, Set<Integer>>>>() {\n-\t\tpublic Pair<Role, Map<String, Set<Integer>>> mapRow(ResultSet rs, int i) throws SQLException {\n-\t\t\ttry {\n-\t\t\t\tMap<String, Set<Integer>> perunBeans = null;\n-\t\t\t\tRole role = Role.valueOf(rs.getString(\"role_name\").toUpperCase());\n-\n-\t\t\t\t// Iterate through all returned columns and try to extract PerunBean name from the labels\n-\t\t\t\tfor (int j = rs.getMetaData().getColumnCount(); j > 0; j--) {\n-\t\t\t\t\tMatcher matcher = patternForExtractingPerunBean.matcher(rs.getMetaData().getColumnLabel(j).toLowerCase());\n-\t\t\t\t\tif (matcher.find()) {\n-\t\t\t\t\t\tString perunBeanName = matcher.group(1);\n-\t\t\t\t\t\tint id = rs.getInt(j);\n-\t\t\t\t\t\tif (!rs.wasNull()) {\n-\t\t\t\t\t\t\t// We have to make first letters o words uppercase\n-\t\t\t\t\t\t\tString className = convertUnderScoreCaseToCamelCase(perunBeanName);\n-\n-\t\t\t\t\t\t\tif (perunBeans == null) {\n-\t\t\t\t\t\t\t\tperunBeans = new HashMap<String, Set<Integer>>();\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\tif (perunBeans.get(className) == null) {\n-\t\t\t\t\t\t\t\tperunBeans.put(className, new HashSet<Integer>());\n-\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\tperunBeans.get(className).add(id);\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\n-\t\t\t\treturn new Pair<Role, Map<String, Set<Integer>>>(role, perunBeans);\n-\n-\t\t\t} catch (Exception e) {\n-\t\t\t\tthrow new InternalErrorRuntimeException(e);\n-\t\t\t}\n-\t\t}\n-\t};\n-\n-\tprivate static String convertUnderScoreCaseToCamelCase(String name) {\n-\t\tboolean nextIsCapital = true;\n-\t\tStringBuilder nameBuilder = new StringBuilder();\n-\t\tfor (char c : name.toCharArray()) {\n-\t\t\tif (c == '_') {\n-\t\t\t\tnextIsCapital = true;\n-\t\t\t} else {\n-\t\t\t\tif (nextIsCapital) {\n-\t\t\t\t\tc = Character.toUpperCase(c);\n-\t\t\t\t\tnextIsCapital = false;\n-\t\t\t\t}\n-\t\t\t\tnameBuilder.append(c);\n-\t\t\t}\n-\t\t}\n-\t\treturn nameBuilder.toString();\n-\t}\n-\n-\tpublic AuthzResolverImpl(DataSource perunPool) {\n-\t\tjdbc = new JdbcPerunTemplate(perunPool);\n-\t}\n-\n-\tpublic AuthzRoles getRoles(User user) throws InternalErrorException {\n-\t\tAuthzRoles authzRoles = new AuthzRoles();\n-\n-\t\tif (user != null) {\n-\t\t\ttry {\n-\t\t\t\t// Get roles from Authz table\n-\t\t\t\tList<Pair<Role, Map<String, Set<Integer>>>> authzRolesPairs = jdbc.query(\"select \" + authzRoleMappingSelectQuery\n-\t\t\t\t\t\t+ \", roles.name as role_name from authz left join roles on authz.role_id=roles.id where authz.user_id=? or authorized_group_id in \"\n-\t\t\t\t\t\t+ \"(select groups.id from groups join groups_members on groups.id=groups_members.group_id join members on \"\n-\t\t\t\t\t\t+ \"members.id=groups_members.member_id join users on users.id=members.user_id where users.id=?)\", AUTHZROLE_MAPPER, user.getId(), user.getId());\n-\n-\t\t\t\tfor (Pair<Role, Map<String, Set<Integer>>> pair : authzRolesPairs) {\n-\t\t\t\t\tauthzRoles.putAuthzRoles(pair.getLeft(), pair.getRight());\n-\t\t\t\t}\n-\n-\t\t\t\t// Get service users for user\n-\t\t\t\tList<Integer> authzServiceUsers = jdbc.query(\"select specific_user_users.specific_user_id as id from users, \" +\n-\t\t\t\t\t\t\"specific_user_users where users.id=specific_user_users.user_id and specific_user_users.status='0' and users.id=? \" +\n-\t\t\t\t        \"and specific_user_users.type=?\", Utils.ID_MAPPER ,user.getId(), SpecificUserType.SERVICE.getSpecificUserType());\n-\t\t\t\tfor (Integer serviceUserId : authzServiceUsers) {\n-\t\t\t\t\tauthzRoles.putAuthzRole(Role.SELF, User.class, serviceUserId);\n-\t\t\t\t}\n-\n-\t\t\t\t// Get members for user\n-\t\t\t\tList<Integer> authzMember = jdbc.query(\"select members.id as id from members where members.user_id=?\",\n-\t\t\t\t\t\tUtils.ID_MAPPER ,user.getId());\n-\t\t\t\tfor (Integer memberId : authzMember) {\n-\t\t\t\t\tauthzRoles.putAuthzRole(Role.SELF, Member.class, memberId);\n-\t\t\t\t}\n-\n-\t\t\t} catch (RuntimeException e) {\n-\t\t\t\tthrow new InternalErrorException(e);\n-\t\t\t}\n-\t\t}\n-\n-\t\treturn authzRoles;\n-\t}\n-\n-\tpublic void initialize() throws InternalErrorException {\n-\n-\t\tif(perun.isPerunReadOnly()) log.debug(\"Loading authzresolver manager init in readOnly version.\");\n-\n-\t\t// Check if all roles defined in class Role exists in the DB\n-\t\tfor (Role role: Role.values()) {\n-\t\t\ttry {\n-\t\t\t\tif (0 == jdbc.queryForInt(\"select count(*) from roles where name=?\", role.getRoleName())) {\n-\t\t\t\t\t//Skip creating not existing roles for read only Perun\n-\t\t\t\t\tif(perun.isPerunReadOnly()) {\n-\t\t\t\t\t\tthrow new InternalErrorException(\"One of deafult roles not exists in DB - \" + role);\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tint newId = Utils.getNewId(jdbc, \"roles_id_seq\");\n-\t\t\t\t\t\tjdbc.update(\"insert into roles (id, name) values (?,?)\", newId, role.getRoleName());\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\t\t\t} catch (RuntimeException e) {\n-\t\t\t\tthrow new InternalErrorException(e);\n-\t\t\t}\n-\t\t}\n-\t}\n-\n-\tpublic static List<Role> getRolesWhichCanWorkWithAttribute(PerunSession sess, ActionType actionType, AttributeDefinition attrDef) throws InternalErrorException {\n-\t\tString actType = actionType.getActionType().toLowerCase();\n-\t\ttry {\n-\t\t\treturn jdbc.query(\"select distinct roles.name from attributes_authz \" +\n-\t\t\t\t\t\"join roles on attributes_authz.role_id=roles.id \" +\n-\t\t\t\t\t\"join action_types on attributes_authz.action_type_id=action_types.id \" +\n-\t\t\t\t\t\"where attributes_authz.attr_id=? and action_types.action_type=?\", AUTHZROLE_MAPPER_FOR_ATTRIBUTES, attrDef.getId(), actType);\n-\t\t} catch (EmptyResultDataAccessException e) {\n-\t\t\treturn new ArrayList<Role>();\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAllUserAuthz(PerunSession sess, User user) throws InternalErrorException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"delete from authz where user_id=?\", user.getId());\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAllSponsoredUserAuthz(PerunSession sess, User sponsoredUser) throws InternalErrorException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"delete from authz where sponsored_user_id=?\", sponsoredUser.getId());\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAllGroupAuthz(PerunSession sess, Group group) throws InternalErrorException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"delete from authz where authorized_group_id=?\", group.getId());\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAllAuthzForVo(PerunSession sess, Vo vo) throws InternalErrorException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"delete from authz where vo_id=?\", vo.getId());\n-\t\t} catch (RuntimeException err) {\n-\t\t\tthrow new InternalErrorException(err);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAllAuthzForGroup(PerunSession sess, Group group) throws InternalErrorException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"delete from authz where group_id=?\", group.getId());\n-\t\t} catch (RuntimeException err) {\n-\t\t\tthrow new InternalErrorException(err);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAllAuthzForFacility(PerunSession sess, Facility facility) throws InternalErrorException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"delete from authz where facility_id=?\", facility.getId());\n-\t\t} catch (RuntimeException err) {\n-\t\t\tthrow new InternalErrorException(err);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAllAuthzForResource(PerunSession sess, Resource resource) throws InternalErrorException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"delete from authz where resource_id=?\", resource.getId());\n-\t\t} catch (RuntimeException err) {\n-\t\t\tthrow new InternalErrorException(err);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAllAuthzForService(PerunSession sess, Service service) throws InternalErrorException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"delete from authz where service_id=?\", service.getId());\n-\t\t} catch (RuntimeException err) {\n-\t\t\tthrow new InternalErrorException(err);\n-\t\t}\n-\t}\n-\n-\t@Override\n-\tpublic void removeAllAuthzForSecurityTeam(PerunSession sess, SecurityTeam securityTeam) throws InternalErrorException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"delete from authz where security_team_id=?\", securityTeam.getId());\n-\t\t} catch (RuntimeException err) {\n-\t\t\tthrow new InternalErrorException(err);\n-\t\t}\n-\t}\n-\n-\tpublic void addAdmin(PerunSession sess, Facility facility, User user) throws InternalErrorException, AlreadyAdminException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"insert into authz (user_id, role_id, facility_id) values (?, (select id from roles where name=?), ?)\", user.getId(), Role.FACILITYADMIN.getRoleName(), facility.getId());\n-\t\t} catch (DataIntegrityViolationException e) {\n-\t\t\tthrow new AlreadyAdminException(\"User id=\" + user.getId() + \" is already admin of the facility \" + facility, e, user, facility);\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void addAdmin(PerunSession sess, Facility facility, Group group) throws InternalErrorException, AlreadyAdminException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"insert into authz (authorized_group_id, role_id, facility_id) values (?, (select id from roles where name=?), ?)\", group.getId(), Role.FACILITYADMIN.getRoleName(), facility.getId());\n-\t\t} catch (DataIntegrityViolationException e) {\n-\t\t\tthrow new AlreadyAdminException(\"Group id=\" + group.getId() + \" is already admin of the facility \" + facility, e, group, facility);\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAdmin(PerunSession sess, Facility facility, User user) throws InternalErrorException, UserNotAdminException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where user_id=? and facility_id=? and role_id=(select id from roles where name=?)\", user.getId(), facility.getId(), Role.FACILITYADMIN.getRoleName())) {\n-\t\t\t\tthrow new UserNotAdminException(\"User id=\" + user.getId() + \" is not admin of the facility \" + facility);\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAdmin(PerunSession sess, Facility facility, Group group) throws InternalErrorException, GroupNotAdminException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where authorized_group_id=? and facility_id=? and role_id=(select id from roles where name=?)\", group.getId(), facility.getId(), Role.FACILITYADMIN.getRoleName())) {\n-\t\t\t\tthrow new GroupNotAdminException(\"Group id=\" + group.getId() + \" is not admin of the facility \" + facility);\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void addAdmin(PerunSession sess, User sponsoredUser, User user) throws InternalErrorException, AlreadyAdminException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"insert into authz (user_id, role_id, sponsored_user_id) values (?, (select id from roles where name=?), ?)\", user.getId(), Role.SPONSOR.getRoleName(), sponsoredUser.getId());\n-\t\t} catch (DataIntegrityViolationException e) {\n-\t\t\tthrow new AlreadyAdminException(\"User id=\" + user.getId() + \" is already sponsor of the sponsoredUser \" + sponsoredUser, e, user, sponsoredUser);\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void addAdmin(PerunSession sess, User sponsoredUser, Group group) throws InternalErrorException, AlreadyAdminException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"insert into authz (authorized_group_id, role_id, sponsored_user_id) values (?, (select id from roles where name=?), ?)\", group.getId(), Role.SPONSOR.getRoleName(), sponsoredUser.getId());\n-\t\t} catch (DataIntegrityViolationException e) {\n-\t\t\tthrow new AlreadyAdminException(\"Group id=\" + group.getId() + \" is already sponsor of the sponsoredUser \" + sponsoredUser, e, group, sponsoredUser);\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAdmin(PerunSession sess, User sponsoredUser, User user) throws InternalErrorException, UserNotAdminException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where user_id=? and sponsored_user_id=? and role_id=(select id from roles where name=?)\", user.getId(), sponsoredUser.getId(), Role.SPONSOR.getRoleName())) {\n-\t\t\t\tthrow new UserNotAdminException(\"User id=\" + user.getId() + \" is not sponsor of the sponsored user \" + sponsoredUser);\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAdmin(PerunSession sess, User sponsoredUser, Group group) throws InternalErrorException, GroupNotAdminException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where authorized_group_id=? and sponsored_user_id=? and role_id=(select id from roles where name=?)\", group.getId(), sponsoredUser.getId(), Role.SPONSOR.getRoleName())) {\n-\t\t\t\tthrow new GroupNotAdminException(\"Group id=\" + group.getId() + \" is not sponsor of the sponsored user \" + sponsoredUser);\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void addAdmin(PerunSession sess, Group group, User user) throws InternalErrorException, AlreadyAdminException {\n-\t\ttry {\n-\t\t\t// Add GROUPADMIN role + groupId and voId\n-\t\t\tjdbc.update(\"insert into authz (user_id, role_id, group_id, vo_id) values (?, (select id from roles where name=?), ?, ?)\",\n-\t\t\t\t\tuser.getId(), Role.GROUPADMIN.getRoleName(), group.getId(), group.getVoId());\n-\t\t} catch (DataIntegrityViolationException e) {\n-\t\t\tthrow new AlreadyAdminException(\"User id=\" + user.getId() + \" is already admin in group \" + group, e, user, group);\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void addAdmin(PerunSession sess, Group group, Group authorizedGroup) throws InternalErrorException, AlreadyAdminException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"insert into authz (authorized_group_id, role_id, group_id, vo_id) values (?, (select id from roles where name=?), ?, ?)\",\n-\t\t\t\t\tauthorizedGroup.getId(), Role.GROUPADMIN.getRoleName(), group.getId(), group.getVoId());\n-\t\t} catch (DataIntegrityViolationException e) {\n-\t\t\tthrow new AlreadyAdminException(\"Group id=\" + authorizedGroup.getId() + \" is already group admin in group \" + group, e, authorizedGroup, group);\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAdmin(PerunSession sess, Group group, User user) throws InternalErrorException, UserNotAdminException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where user_id=? and group_id=? and role_id=(select id from roles where name=?)\",\n-\t\t\t\t\t\tuser.getId(), group.getId(), Role.GROUPADMIN.getRoleName())) {\n-\t\t\t\tthrow new UserNotAdminException(\"User id=\" + user.getId() + \" is not admin of the group \" + group);\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAdmin(PerunSession sess, Group group, Group authorizedGroup) throws InternalErrorException, GroupNotAdminException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where authorized_group_id=? and group_id=? and role_id=(select id from roles where name=?)\",\n-\t\t\t\t\t\tauthorizedGroup.getId(), group.getId(), Role.GROUPADMIN.getRoleName())) {\n-\t\t\t\tthrow new GroupNotAdminException(\"Group id=\" + authorizedGroup.getId() + \" is not admin of the group \" + group);\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void addAdmin(PerunSession sess, Vo vo, User user) throws InternalErrorException, AlreadyAdminException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"insert into authz (user_id, role_id, vo_id) values (?, (select id from roles where name=?), ?)\", user.getId(),\n-\t\t\t\t\tRole.VOADMIN.getRoleName(), vo.getId());\n-\t\t} catch (DataIntegrityViolationException e) {\n-\t\t\tthrow new AlreadyAdminException(\"User id=\" + user.getId() + \" is already admin in vo \" + vo, e, user, vo);\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void addAdmin(PerunSession sess, Vo vo, Group group) throws InternalErrorException, AlreadyAdminException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"insert into authz (role_id, vo_id, authorized_group_id) values ((select id from roles where name=?), ?, ?)\",\n-\t\t\t\t\tRole.VOADMIN.getRoleName(), vo.getId(), group.getId());\n-\t\t} catch (DataIntegrityViolationException e) {\n-\t\t\tthrow new AlreadyAdminException(\"Group id=\" + group.getId() + \" is already admin in vo \" + vo, e, group, vo);\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\t@Override\n-\tpublic void addAdmin(PerunSession sess, SecurityTeam securityTeam, User user) throws AlreadyAdminException, InternalErrorException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"insert into authz (user_id, role_id, security_team_id) values (?, (select id from roles where name=?), ?)\", user.getId(),\n-\t\t\t\t\tRole.SECURITYADMIN.getRoleName(), securityTeam.getId());\n-\t\t} catch (DataIntegrityViolationException e) {\n-\t\t\tthrow new AlreadyAdminException(\"User id=\" + user.getId() + \" is already admin in securityTeam \" + securityTeam, e, user, securityTeam);\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\t@Override\n-\tpublic void addAdmin(PerunSession sess, SecurityTeam securityTeam, Group group) throws AlreadyAdminException, InternalErrorException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"insert into authz (authorized_group_id, role_id, security_team_id) values (?, (select id from roles where name=?), ?)\", group.getId(),\n-\t\t\t\t\tRole.SECURITYADMIN.getRoleName(), securityTeam.getId());\n-\t\t} catch (DataIntegrityViolationException e) {\n-\t\t\tthrow new AlreadyAdminException(\"Group id=\" + group.getId() + \" is already admin in securityTeam \" + securityTeam, e, group, securityTeam);\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void addObserver(PerunSession sess, Vo vo, User user) throws InternalErrorException, AlreadyAdminException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"insert into authz (user_id, role_id, vo_id) values (?, (select id from roles where name=?), ?)\", user.getId(),\n-\t\t\t\t\tRole.VOOBSERVER.getRoleName(), vo.getId());\n-\t\t} catch (DataIntegrityViolationException e) {\n-\t\t\tthrow new AlreadyAdminException(\"User id=\" + user.getId() + \" is already observer in vo \" + vo, e, user, vo);\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void addObserver(PerunSession sess, Vo vo, Group group) throws InternalErrorException, AlreadyAdminException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"insert into authz (role_id, vo_id, authorized_group_id) values ((select id from roles where name=?), ?, ?)\",\n-\t\t\t\t\tRole.VOOBSERVER.getRoleName(), vo.getId(), group.getId());\n-\t\t} catch (DataIntegrityViolationException e) {\n-\t\t\tthrow new AlreadyAdminException(\"Group id=\" + group.getId() + \" is already observer in vo \" + vo, e, group, vo);\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void addTopGroupCreator(PerunSession sess, Vo vo, User user) throws InternalErrorException, AlreadyAdminException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"insert into authz (user_id, role_id, vo_id) values (?, (select id from roles where name=?), ?)\", user.getId(),\n-\t\t\t\t\tRole.TOPGROUPCREATOR.getRoleName(), vo.getId());\n-\t\t} catch (DataIntegrityViolationException e) {\n-\t\t\tthrow new AlreadyAdminException(\"User id=\" + user.getId() + \" is already observer in vo \" + vo, e, user, vo);\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void addTopGroupCreator(PerunSession sess, Vo vo, Group group) throws InternalErrorException, AlreadyAdminException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"insert into authz (role_id, vo_id, authorized_group_id) values ((select id from roles where name=?), ?, ?)\",\n-\t\t\t\t\tRole.TOPGROUPCREATOR.getRoleName(), vo.getId(), group.getId());\n-\t\t} catch (DataIntegrityViolationException e) {\n-\t\t\tthrow new AlreadyAdminException(\"Group id=\" + group.getId() + \" is already observer in vo \" + vo, e, group, vo);\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeObserver(PerunSession sess, Vo vo, User user) throws InternalErrorException, UserNotAdminException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where user_id=? and vo_id=? and role_id=(select id from roles where name=?)\", user.getId(), vo.getId(), Role.VOOBSERVER.getRoleName())) {\n-\t\t\t\tthrow new UserNotAdminException(\"User id=\" + user.getId() + \" is not observer of the vo \" + vo);\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeObserver(PerunSession sess, Vo vo, Group group) throws InternalErrorException, GroupNotAdminException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where authorized_group_id=? and vo_id=? and role_id=(select id from roles where name=?)\", group.getId(), vo.getId(), Role.VOOBSERVER.getRoleName())) {\n-\t\t\t\tthrow new GroupNotAdminException(\"Group id=\" + group.getId() + \" is not observer of the vo \" + vo);\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeTopGroupCreator(PerunSession sess, Vo vo, User user) throws InternalErrorException, UserNotAdminException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where user_id=? and vo_id=? and role_id=(select id from roles where name=?)\", user.getId(), vo.getId(), Role.TOPGROUPCREATOR.getRoleName())) {\n-\t\t\t\tthrow new UserNotAdminException(\"User id=\" + user.getId() + \" is not observer of the vo \" + vo);\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeTopGroupCreator(PerunSession sess, Vo vo, Group group) throws InternalErrorException, GroupNotAdminException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where authorized_group_id=? and vo_id=? and role_id=(select id from roles where name=?)\", group.getId(), vo.getId(), Role.TOPGROUPCREATOR.getRoleName())) {\n-\t\t\t\tthrow new GroupNotAdminException(\"Group id=\" + group.getId() + \" is not observer of the vo \" + vo);\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAdmin(PerunSession sess, Vo vo, User user) throws InternalErrorException, UserNotAdminException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where user_id=? and vo_id=? and role_id=(select id from roles where name=?)\", user.getId(), vo.getId(), Role.VOADMIN.getRoleName())) {\n-\t\t\t\tthrow new UserNotAdminException(\"User id=\" + user.getId() + \" is not admin of the vo \" + vo);\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAdmin(PerunSession sess, Vo vo, Group group) throws InternalErrorException, GroupNotAdminException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where authorized_group_id=? and vo_id=? and role_id=(select id from roles where name=?)\", group.getId(), vo.getId(), Role.VOADMIN.getRoleName())) {\n-\t\t\t\tthrow new GroupNotAdminException(\"Group id=\" + group.getId() + \" is not admin of the vo \" + vo);\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\t@Override\n-\tpublic void removeAdmin(PerunSession sess, SecurityTeam securityTeam, User user) throws UserNotAdminException, InternalErrorException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where user_id=? and security_team_id=? and role_id=(select id from roles where name=?)\", user.getId(), securityTeam.getId(), Role.SECURITYADMIN.getRoleName())) {\n-\t\t\t\tthrow new UserNotAdminException(\"User id=\" + user.getId() + \" is not admin of the security team \" + securityTeam);\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\t@Override\n-\tpublic void removeAdmin(PerunSession sess, SecurityTeam securityTeam, Group group) throws GroupNotAdminException, InternalErrorException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where authorized_group_id=? and security_team_id=? and role_id=(select id from roles where name=?)\", group.getId(), securityTeam.getId(), Role.SECURITYADMIN.getRoleName())) {\n-\t\t\t\tthrow new GroupNotAdminException(\"Group id=\" + group.getId() + \" is not admin of the security team \" + securityTeam);\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void makeUserPerunAdmin(PerunSession sess, User user) throws InternalErrorException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"insert into authz (user_id, role_id) values (?, (select id from roles where name=?))\", user.getId(), Role.PERUNADMIN.getRoleName());\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removePerunAdmin(PerunSession sess, User user) throws InternalErrorException, UserNotAdminException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where user_id=? and role_id=(select id from roles where name=?)\", user.getId(), Role.PERUNADMIN.getRoleName())) {\n-\t\t\t\tthrow new UserNotAdminException(\"User id=\" + user.getId() + \" is not perun admin.\");\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void setPerun(Perun perun) {\n-\t\tthis.perun = perun;\n-\t}\n+    final static Logger log = LoggerFactory.getLogger(FacilitiesManagerImpl.class);\n+\n+    //http://static.springsource.org/spring/docs/3.0.x/spring-framework-reference/html/jdbc.html\n+    private static JdbcPerunTemplate jdbc;\n+\n+    private Perun perun;\n+    private final static Pattern patternForExtractingPerunBean = Pattern.compile(\"^pb_([a-z_]+)_id$\");\n+\n+    public final static String authzRoleMappingSelectQuery = \" authz.user_id as authz_user_id, authz.role_id as authz_role_id,\" +\n+            \"authz.authorized_group_id as authz_authorized_group_id, authz.vo_id as pb_vo_id, authz.group_id as pb_group_id, \" +\n+            \"authz.facility_id as pb_facility_id, authz.member_id as pb_member_id, authz.resource_id as pb_resource_id, \" +\n+            \"authz.service_id as pb_service_id, authz.service_principal_id as pb_user_id, authz.security_team_id as pb_security_team_id, \" +\n+            \"authz.sponsored_user_id as pb_sponsored_user_id\";\n+\n+\n+    protected static final RowMapper<Role> AUTHZROLE_MAPPER_FOR_ATTRIBUTES = new RowMapper<Role>() {\n+        public Role mapRow(ResultSet rs, int i) throws SQLException {\n+            Role role = Role.valueOf(rs.getString(\"name\").toUpperCase());\n+            return role;\n+        }\n+    };\n+\n+    public static final RowMapper<Pair<Role, Map<String, Set<Integer>>>> AUTHZROLE_MAPPER = new RowMapper<Pair<Role, Map<String, Set<Integer>>>>() {\n+        public Pair<Role, Map<String, Set<Integer>>> mapRow(ResultSet rs, int i) throws SQLException {\n+            try {\n+                Map<String, Set<Integer>> perunBeans = null;\n+                Role role = Role.valueOf(rs.getString(\"role_name\").toUpperCase());\n+\n+                // Iterate through all returned columns and try to extract PerunBean name from the labels\n+                for (int j = rs.getMetaData().getColumnCount(); j > 0; j--) {\n+                    Matcher matcher = patternForExtractingPerunBean.matcher(rs.getMetaData().getColumnLabel(j).toLowerCase());\n+                    if (matcher.find()) {\n+                        String perunBeanName = matcher.group(1);\n+                        int id = rs.getInt(j);\n+                        if (!rs.wasNull()) {\n+                            // We have to make first letters o words uppercase\n+                            String className = convertUnderScoreCaseToCamelCase(perunBeanName);\n+\n+                            if (perunBeans == null) {\n+                                perunBeans = new HashMap<String, Set<Integer>>();\n+                            }\n+                            if (perunBeans.get(className) == null) {\n+                                perunBeans.put(className, new HashSet<Integer>());\n+\n+                            }\n+                            perunBeans.get(className).add(id);\n+                        }\n+                    }\n+                }\n+\n+                return new Pair<Role, Map<String, Set<Integer>>>(role, perunBeans);\n+\n+            } catch (Exception e) {\n+                throw new InternalErrorRuntimeException(e);\n+            }\n+        }\n+    };\n+\n+    private static String convertUnderScoreCaseToCamelCase(String name) {\n+        boolean nextIsCapital = true;\n+        StringBuilder nameBuilder = new StringBuilder();\n+        for (char c : name.toCharArray()) {\n+            if (c == '_') {\n+                nextIsCapital = true;\n+            } else {\n+                if (nextIsCapital) {\n+                    c = Character.toUpperCase(c);\n+                    nextIsCapital = false;\n+                }\n+                nameBuilder.append(c);\n+            }\n+        }\n+        return nameBuilder.toString();\n+    }\n+\n+    public AuthzResolverImpl(DataSource perunPool) {\n+        jdbc = new JdbcPerunTemplate(perunPool);\n+    }\n+\n+    public AuthzRoles getRoles(User user) throws InternalErrorException {\n+        AuthzRoles authzRoles = new AuthzRoles();\n+\n+        if (user != null) {\n+            try {\n+                // Get roles from Authz table\n+                List<Pair<Role, Map<String, Set<Integer>>>> authzRolesPairs = jdbc.query(\"select \" + authzRoleMappingSelectQuery\n+                        + \", roles.name as role_name from authz left join roles on authz.role_id=roles.id where authz.user_id=? or authorized_group_id in \"\n+                        + \"(select groups.id from groups join groups_members on groups.id=groups_members.group_id join members on \"\n+                        + \"members.id=groups_members.member_id join users on users.id=members.user_id where users.id=?)\", AUTHZROLE_MAPPER, user.getId(), user.getId());\n+\n+                for (Pair<Role, Map<String, Set<Integer>>> pair : authzRolesPairs) {\n+                    authzRoles.putAuthzRoles(pair.getLeft(), pair.getRight());\n+                }\n+\n+                // Get service users for user\n+                List<Integer> authzServiceUsers = jdbc.query(\"select specific_user_users.specific_user_id as id from users, \" +\n+                        \"specific_user_users where users.id=specific_user_users.user_id and specific_user_users.status='0' and users.id=? \" +\n+                        \"and specific_user_users.type=?\", Utils.ID_MAPPER, user.getId(), SpecificUserType.SERVICE.getSpecificUserType());\n+                for (Integer serviceUserId : authzServiceUsers) {\n+                    authzRoles.putAuthzRole(Role.SELF, User.class, serviceUserId);\n+                }\n+\n+                // Get members for user\n+                List<Integer> authzMember = jdbc.query(\"select members.id as id from members where members.user_id=?\",\n+                        Utils.ID_MAPPER, user.getId());\n+                for (Integer memberId : authzMember) {\n+                    authzRoles.putAuthzRole(Role.SELF, Member.class, memberId);\n+                }\n+\n+            } catch (RuntimeException e) {\n+                throw new InternalErrorException(e);\n+            }\n+        }\n+\n+        return authzRoles;\n+    }\n+\n+    public void initialize() throws InternalErrorException {\n+\n+        if (perun.isPerunReadOnly()) {\n+            log.debug(\"Loading authzresolver manager init in readOnly version.\");\n+        }\n+\n+        // Check if all roles defined in class Role exists in the DB\n+        for (Role role : Role.values()) {\n+            try {\n+                if (0 == jdbc.queryForInt(\"select count(*) from roles where name=?\", role.getRoleName())) {\n+                    //Skip creating not existing roles for read only Perun\n+                    if (perun.isPerunReadOnly()) {\n+                        throw new InternalErrorException(\"One of deafult roles not exists in DB - \" + role);\n+                    } else {\n+                        int newId = Utils.getNewId(jdbc, \"roles_id_seq\");\n+                        jdbc.update(\"insert into roles (id, name) values (?,?)\", newId, role.getRoleName());\n+                    }\n+                }\n+            } catch (RuntimeException e) {\n+                throw new InternalErrorException(e);\n+            }\n+        }\n+    }\n+\n+    public static List<Role> getRolesWhichCanWorkWithAttribute(PerunSession sess, ActionType actionType, AttributeDefinition attrDef) throws InternalErrorException {\n+        String actType = actionType.getActionType().toLowerCase();\n+        try {\n+            return jdbc.query(\"select distinct roles.name from attributes_authz \" +\n+                    \"join roles on attributes_authz.role_id=roles.id \" +\n+                    \"join action_types on attributes_authz.action_type_id=action_types.id \" +\n+                    \"where attributes_authz.attr_id=? and action_types.action_type=?\", AUTHZROLE_MAPPER_FOR_ATTRIBUTES, attrDef.getId(), actType);\n+        } catch (EmptyResultDataAccessException e) {\n+            return new ArrayList<Role>();\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void removeAllUserAuthz(PerunSession sess, User user) throws InternalErrorException {\n+        try {\n+            jdbc.update(\"delete from authz where user_id=?\", user.getId());\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void removeAllSponsoredUserAuthz(PerunSession sess, User sponsoredUser) throws InternalErrorException {\n+        try {\n+            jdbc.update(\"delete from authz where sponsored_user_id=?\", sponsoredUser.getId());\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void removeAllGroupAuthz(PerunSession sess, Group group) throws InternalErrorException {\n+        try {\n+            jdbc.update(\"delete from authz where authorized_group_id=?\", group.getId());\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void removeAllAuthzForVo(PerunSession sess, Vo vo) throws InternalErrorException {\n+        try {\n+            jdbc.update(\"delete from authz where vo_id=?\", vo.getId());\n+        } catch (RuntimeException err) {\n+            throw new InternalErrorException(err);\n+        }\n+    }\n+\n+    public void removeAllAuthzForGroup(PerunSession sess, Group group) throws InternalErrorException {\n+        try {\n+            jdbc.update(\"delete from authz where group_id=?\", group.getId());\n+        } catch (RuntimeException err) {\n+            throw new InternalErrorException(err);\n+        }\n+    }\n+\n+    public void removeAllAuthzForFacility(PerunSession sess, Facility facility) throws InternalErrorException {\n+        try {\n+            jdbc.update(\"delete from authz where facility_id=?\", facility.getId());\n+        } catch (RuntimeException err) {\n+            throw new InternalErrorException(err);\n+        }\n+    }\n+\n+    public void removeAllAuthzForResource(PerunSession sess, Resource resource) throws InternalErrorException {\n+        try {\n+            jdbc.update(\"delete from authz where resource_id=?\", resource.getId());\n+        } catch (RuntimeException err) {\n+            throw new InternalErrorException(err);\n+        }\n+    }\n+\n+    public void removeAllAuthzForService(PerunSession sess, Service service) throws InternalErrorException {\n+        try {\n+            jdbc.update(\"delete from authz where service_id=?\", service.getId());\n+        } catch (RuntimeException err) {\n+            throw new InternalErrorException(err);\n+        }\n+    }\n+\n+    @Override\n+    public void removeAllAuthzForSecurityTeam(PerunSession sess, SecurityTeam securityTeam) throws InternalErrorException {\n+        try {\n+            jdbc.update(\"delete from authz where security_team_id=?\", securityTeam.getId());\n+        } catch (RuntimeException err) {\n+            throw new InternalErrorException(err);\n+        }\n+    }\n+\n+    public void addAdmin(PerunSession sess, Facility facility, User user) throws InternalErrorException, AlreadyAdminException {\n+        try {\n+            jdbc.update(\"insert into authz (user_id, role_id, facility_id) values (?, (select id from roles where name=?), ?)\", user.getId(), Role.FACILITYADMIN.getRoleName(), facility.getId());\n+        } catch (DataIntegrityViolationException e) {\n+            throw new AlreadyAdminException(\"User id=\" + user.getId() + \" is already admin of the facility \" + facility, e, user, facility);\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void addAdmin(PerunSession sess, Facility facility, Group group) throws InternalErrorException, AlreadyAdminException {\n+        try {\n+            jdbc.update(\"insert into authz (authorized_group_id, role_id, facility_id) values (?, (select id from roles where name=?), ?)\", group.getId(), Role.FACILITYADMIN.getRoleName(), facility.getId());\n+        } catch (DataIntegrityViolationException e) {\n+            throw new AlreadyAdminException(\"Group id=\" + group.getId() + \" is already admin of the facility \" + facility, e, group, facility);\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void removeAdmin(PerunSession sess, Facility facility, User user) throws InternalErrorException, UserNotAdminException {\n+        try {\n+            if (0 == jdbc.update(\"delete from authz where user_id=? and facility_id=? and role_id=(select id from roles where name=?)\", user.getId(), facility.getId(), Role.FACILITYADMIN.getRoleName())) {\n+                throw new UserNotAdminException(\"User id=\" + user.getId() + \" is not admin of the facility \" + facility);\n+            }\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void removeAdmin(PerunSession sess, Facility facility, Group group) throws InternalErrorException, GroupNotAdminException {\n+        try {\n+            if (0 == jdbc.update(\"delete from authz where authorized_group_id=? and facility_id=? and role_id=(select id from roles where name=?)\", group.getId(), facility.getId(), Role.FACILITYADMIN.getRoleName())) {\n+                throw new GroupNotAdminException(\"Group id=\" + group.getId() + \" is not admin of the facility \" + facility);\n+            }\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void addAdmin(PerunSession sess, User sponsoredUser, User user) throws InternalErrorException, AlreadyAdminException {\n+        try {\n+            jdbc.update(\"insert into authz (user_id, role_id, sponsored_user_id) values (?, (select id from roles where name=?), ?)\", user.getId(), Role.SPONSOR.getRoleName(), sponsoredUser.getId());\n+        } catch (DataIntegrityViolationException e) {\n+            throw new AlreadyAdminException(\"User id=\" + user.getId() + \" is already sponsor of the sponsoredUser \" + sponsoredUser, e, user, sponsoredUser);\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void addAdmin(PerunSession sess, User sponsoredUser, Group group) throws InternalErrorException, AlreadyAdminException {\n+        try {\n+            jdbc.update(\"insert into authz (authorized_group_id, role_id, sponsored_user_id) values (?, (select id from roles where name=?), ?)\", group.getId(), Role.SPONSOR.getRoleName(), sponsoredUser.getId());\n+        } catch (DataIntegrityViolationException e) {\n+            throw new AlreadyAdminException(\"Group id=\" + group.getId() + \" is already sponsor of the sponsoredUser \" + sponsoredUser, e, group, sponsoredUser);\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void removeAdmin(PerunSession sess, User sponsoredUser, User user) throws InternalErrorException, UserNotAdminException {\n+        try {\n+            if (0 == jdbc.update(\"delete from authz where user_id=? and sponsored_user_id=? and role_id=(select id from roles where name=?)\", user.getId(), sponsoredUser.getId(), Role.SPONSOR.getRoleName())) {\n+                throw new UserNotAdminException(\"User id=\" + user.getId() + \" is not sponsor of the sponsored user \" + sponsoredUser);\n+            }\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void removeAdmin(PerunSession sess, User sponsoredUser, Group group) throws InternalErrorException, GroupNotAdminException {\n+        try {\n+            if (0 == jdbc.update(\"delete from authz where authorized_group_id=? and sponsored_user_id=? and role_id=(select id from roles where name=?)\", group.getId(), sponsoredUser.getId(), Role.SPONSOR.getRoleName())) {\n+                throw new GroupNotAdminException(\"Group id=\" + group.getId() + \" is not sponsor of the sponsored user \" + sponsoredUser);\n+            }\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void addAdmin(PerunSession sess, Group group, User user) throws InternalErrorException, AlreadyAdminException {\n+        try {\n+            // Add GROUPADMIN role + groupId and voId\n+            jdbc.update(\"insert into authz (user_id, role_id, group_id, vo_id) values (?, (select id from roles where name=?), ?, ?)\",\n+                    user.getId(), Role.GROUPADMIN.getRoleName(), group.getId(), group.getVoId());\n+        } catch (DataIntegrityViolationException e) {\n+            throw new AlreadyAdminException(\"User id=\" + user.getId() + \" is already admin in group \" + group, e, user, group);\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void addAdmin(PerunSession sess, Group group, Group authorizedGroup) throws InternalErrorException, AlreadyAdminException {\n+        try {\n+            jdbc.update(\"insert into authz (authorized_group_id, role_id, group_id, vo_id) values (?, (select id from roles where name=?), ?, ?)\",\n+                    authorizedGroup.getId(), Role.GROUPADMIN.getRoleName(), group.getId(), group.getVoId());\n+        } catch (DataIntegrityViolationException e) {\n+            throw new AlreadyAdminException(\"Group id=\" + authorizedGroup.getId() + \" is already group admin in group \" + group, e, authorizedGroup, group);\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void removeAdmin(PerunSession sess, Group group, User user) throws InternalErrorException, UserNotAdminException {\n+        try {\n+            if (0 == jdbc.update(\"delete from authz where user_id=? and group_id=? and role_id=(select id from roles where name=?)\",\n+                    user.getId(), group.getId(), Role.GROUPADMIN.getRoleName())) {\n+                throw new UserNotAdminException(\"User id=\" + user.getId() + \" is not admin of the group \" + group);\n+            }\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void removeAdmin(PerunSession sess, Group group, Group authorizedGroup) throws InternalErrorException, GroupNotAdminException {\n+        try {\n+            if (0 == jdbc.update(\"delete from authz where authorized_group_id=? and group_id=? and role_id=(select id from roles where name=?)\",\n+                    authorizedGroup.getId(), group.getId(), Role.GROUPADMIN.getRoleName())) {\n+                throw new GroupNotAdminException(\"Group id=\" + authorizedGroup.getId() + \" is not admin of the group \" + group);\n+            }\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void addAdmin(PerunSession sess, Vo vo, User user) throws InternalErrorException, AlreadyAdminException {\n+        try {\n+            jdbc.update(\"insert into authz (user_id, role_id, vo_id) values (?, (select id from roles where name=?), ?)\", user.getId(),\n+                    Role.VOADMIN.getRoleName(), vo.getId());\n+        } catch (DataIntegrityViolationException e) {\n+            throw new AlreadyAdminException(\"User id=\" + user.getId() + \" is already admin in vo \" + vo, e, user, vo);\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void addAdmin(PerunSession sess, Vo vo, Group group) throws InternalErrorException, AlreadyAdminException {\n+        try {\n+            jdbc.update(\"insert into authz (role_id, vo_id, authorized_group_id) values ((select id from roles where name=?), ?, ?)\",\n+                    Role.VOADMIN.getRoleName(), vo.getId(), group.getId());\n+        } catch (DataIntegrityViolationException e) {\n+            throw new AlreadyAdminException(\"Group id=\" + group.getId() + \" is already admin in vo \" + vo, e, group, vo);\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    @Override\n+    public void addAdmin(PerunSession sess, SecurityTeam securityTeam, User user) throws AlreadyAdminException, InternalErrorException {\n+        try {\n+            jdbc.update(\"insert into authz (user_id, role_id, security_team_id) values (?, (select id from roles where name=?), ?)\", user.getId(),\n+                    Role.SECURITYADMIN.getRoleName(), securityTeam.getId());\n+        } catch (DataIntegrityViolationException e) {\n+            throw new AlreadyAdminException(\"User id=\" + user.getId() + \" is already admin in securityTeam \" + securityTeam, e, user, securityTeam);\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    @Override\n+    public void addAdmin(PerunSession sess, SecurityTeam securityTeam, Group group) throws AlreadyAdminException, InternalErrorException {\n+        try {\n+            jdbc.update(\"insert into authz (authorized_group_id, role_id, security_team_id) values (?, (select id from roles where name=?), ?)\", group.getId(),\n+                    Role.SECURITYADMIN.getRoleName(), securityTeam.getId());\n+        } catch (DataIntegrityViolationException e) {\n+            throw new AlreadyAdminException(\"Group id=\" + group.getId() + \" is already admin in securityTeam \" + securityTeam, e, group, securityTeam);\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void addObserver(PerunSession sess, Vo vo, User user) throws InternalErrorException, AlreadyAdminException {\n+        try {\n+            jdbc.update(\"insert into authz (user_id, role_id, vo_id) values (?, (select id from roles where name=?), ?)\", user.getId(),\n+                    Role.VOOBSERVER.getRoleName(), vo.getId());\n+        } catch (DataIntegrityViolationException e) {\n+            throw new AlreadyAdminException(\"User id=\" + user.getId() + \" is already observer in vo \" + vo, e, user, vo);\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void addObserver(PerunSession sess, Vo vo, Group group) throws InternalErrorException, AlreadyAdminException {\n+        try {\n+            jdbc.update(\"insert into authz (role_id, vo_id, authorized_group_id) values ((select id from roles where name=?), ?, ?)\",\n+                    Role.VOOBSERVER.getRoleName(), vo.getId(), group.getId());\n+        } catch (DataIntegrityViolationException e) {\n+            throw new AlreadyAdminException(\"Group id=\" + group.getId() + \" is already observer in vo \" + vo, e, group, vo);\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void addTopGroupCreator(PerunSession sess, Vo vo, User user) throws InternalErrorException, AlreadyAdminException {\n+        try {\n+            jdbc.update(\"insert into authz (user_id, role_id, vo_id) values (?, (select id from roles where name=?), ?)\", user.getId(),\n+                    Role.TOPGROUPCREATOR.getRoleName(), vo.getId());\n+        } catch (DataIntegrityViolationException e) {\n+            throw new AlreadyAdminException(\"User id=\" + user.getId() + \" is already observer in vo \" + vo, e, user, vo);\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void addTopGroupCreator(PerunSession sess, Vo vo, Group group) throws InternalErrorException, AlreadyAdminException {\n+        try {\n+            jdbc.update(\"insert into authz (role_id, vo_id, authorized_group_id) values ((select id from roles where name=?), ?, ?)\",\n+                    Role.TOPGROUPCREATOR.getRoleName(), vo.getId(), group.getId());\n+        } catch (DataIntegrityViolationException e) {\n+            throw new AlreadyAdminException(\"Group id=\" + group.getId() + \" is already observer in vo \" + vo, e, group, vo);\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void removeObserver(PerunSession sess, Vo vo, User user) throws InternalErrorException, UserNotAdminException {\n+        try {\n+            if (0 == jdbc.update(\"delete from authz where user_id=? and vo_id=? and role_id=(select id from roles where name=?)\", user.getId(), vo.getId(), Role.VOOBSERVER.getRoleName())) {\n+                throw new UserNotAdminException(\"User id=\" + user.getId() + \" is not observer of the vo \" + vo);\n+            }\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void removeObserver(PerunSession sess, Vo vo, Group group) throws InternalErrorException, GroupNotAdminException {\n+        try {\n+            if (0 == jdbc.update(\"delete from authz where authorized_group_id=? and vo_id=? and role_id=(select id from roles where name=?)\", group.getId(), vo.getId(), Role.VOOBSERVER.getRoleName())) {\n+                throw new GroupNotAdminException(\"Group id=\" + group.getId() + \" is not observer of the vo \" + vo);\n+            }\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void removeTopGroupCreator(PerunSession sess, Vo vo, User user) throws InternalErrorException, UserNotAdminException {\n+        try {\n+            if (0 == jdbc.update(\"delete from authz where user_id=? and vo_id=? and role_id=(select id from roles where name=?)\", user.getId(), vo.getId(), Role.TOPGROUPCREATOR.getRoleName())) {\n+                throw new UserNotAdminException(\"User id=\" + user.getId() + \" is not observer of the vo \" + vo);\n+            }\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void removeTopGroupCreator(PerunSession sess, Vo vo, Group group) throws InternalErrorException, GroupNotAdminException {\n+        try {\n+            if (0 == jdbc.update(\"delete from authz where authorized_group_id=? and vo_id=? and role_id=(select id from roles where name=?)\", group.getId(), vo.getId(), Role.TOPGROUPCREATOR.getRoleName())) {\n+                throw new GroupNotAdminException(\"Group id=\" + group.getId() + \" is not observer of the vo \" + vo);\n+            }\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void removeAdmin(PerunSession sess, Vo vo, User user) throws InternalErrorException, UserNotAdminException {\n+        try {\n+            if (0 == jdbc.update(\"delete from authz where user_id=? and vo_id=? and role_id=(select id from roles where name=?)\", user.getId(), vo.getId(), Role.VOADMIN.getRoleName())) {\n+                throw new UserNotAdminException(\"User id=\" + user.getId() + \" is not admin of the vo \" + vo);\n+            }\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void removeAdmin(PerunSession sess, Vo vo, Group group) throws InternalErrorException, GroupNotAdminException {\n+        try {\n+            if (0 == jdbc.update(\"delete from authz where authorized_group_id=? and vo_id=? and role_id=(select id from roles where name=?)\", group.getId(), vo.getId(), Role.VOADMIN.getRoleName())) {\n+                throw new GroupNotAdminException(\"Group id=\" + group.getId() + \" is not admin of the vo \" + vo);\n+            }\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    @Override\n+    public void removeAdmin(PerunSession sess, SecurityTeam securityTeam, User user) throws UserNotAdminException, InternalErrorException {\n+        try {\n+            if (0 == jdbc.update(\"delete from authz where user_id=? and security_team_id=? and role_id=(select id from roles where name=?)\", user.getId(), securityTeam.getId(), Role.SECURITYADMIN.getRoleName())) {\n+                throw new UserNotAdminException(\"User id=\" + user.getId() + \" is not admin of the security team \" + securityTeam);\n+            }\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    @Override\n+    public void removeAdmin(PerunSession sess, SecurityTeam securityTeam, Group group) throws GroupNotAdminException, InternalErrorException {\n+        try {\n+            if (0 == jdbc.update(\"delete from authz where authorized_group_id=? and security_team_id=? and role_id=(select id from roles where name=?)\", group.getId(), securityTeam.getId(), Role.SECURITYADMIN.getRoleName())) {\n+                throw new GroupNotAdminException(\"Group id=\" + group.getId() + \" is not admin of the security team \" + securityTeam);\n+            }\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void makeUserPerunAdmin(PerunSession sess, User user) throws InternalErrorException {\n+        try {\n+            jdbc.update(\"insert into authz (user_id, role_id) values (?, (select id from roles where name=?))\", user.getId(), Role.PERUNADMIN.getRoleName());\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void removePerunAdmin(PerunSession sess, User user) throws InternalErrorException, UserNotAdminException {\n+        try {\n+            if (0 == jdbc.update(\"delete from authz where user_id=? and role_id=(select id from roles where name=?)\", user.getId(), Role.PERUNADMIN.getRoleName())) {\n+                throw new UserNotAdminException(\"User id=\" + user.getId() + \" is not perun admin.\");\n+            }\n+        } catch (RuntimeException e) {\n+            throw new InternalErrorException(e);\n+        }\n+    }\n+\n+    public void setPerun(Perun perun) {\n+        this.perun = perun;\n+    }\n }\n",
            "diff_size": 549
        },
        {
            "tool": "naturalize",
            "errors": null,
            "diff": null
        },
        {
            "tool": "codebuff",
            "errors": [],
            "diff": "diff --git a/home/fernanda/mnt/fernanda/git-styler/styler/python/experiments/results/CESNET-perun/errored/1/507/AuthzResolverImpl.java b/home/fernanda/mnt/fernanda/git-styler/styler/python/experiments/results/CESNET-perun/codebuff/507/AuthzResolverImpl.java\nindex ca195b2458a..db58a70e1fd 100644\n--- a/home/fernanda/mnt/fernanda/git-styler/styler/python/experiments/results/CESNET-perun/errored/1/507/AuthzResolverImpl.java\n+++ b/home/fernanda/mnt/fernanda/git-styler/styler/python/experiments/results/CESNET-perun/codebuff/507/AuthzResolverImpl.java\n@@ -12,14 +12,11 @@ import java.util.List;\n import java.util.Map;\n import java.util.regex.Matcher;\n import java.util.regex.Pattern;\n-\n import javax.sql.DataSource;\n-\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import org.springframework.jdbc.core.JdbcPerunTemplate;\n import org.springframework.jdbc.core.RowMapper;\n-\n import cz.metacentrum.perun.core.api.Member;\n import cz.metacentrum.perun.core.api.Pair;\n import cz.metacentrum.perun.core.api.Perun;\n@@ -42,550 +39,527 @@ import java.util.Set;\n import org.springframework.dao.DataIntegrityViolationException;\n import org.springframework.dao.EmptyResultDataAccessException;\n \n+\n public class AuthzResolverImpl implements AuthzResolverImplApi {\n \n-\tfinal static Logger log = LoggerFactory.getLogger(FacilitiesManagerImpl.class);\n-\n-\t//http://static.springsource.org/spring/docs/3.0.x/spring-framework-reference/html/jdbc.html\n-\tprivate static JdbcPerunTemplate jdbc;\n-\n-\tprivate Perun perun;\n-\tprivate final static Pattern patternForExtractingPerunBean = Pattern.compile(\"^pb_([a-z_]+)_id$\");\n-\n-\tpublic final static String authzRoleMappingSelectQuery = \" authz.user_id as authz_user_id, authz.role_id as authz_role_id,\" +\n-\t\t\"authz.authorized_group_id as authz_authorized_group_id, authz.vo_id as pb_vo_id, authz.group_id as pb_group_id, \" +\n-\t\t\"authz.facility_id as pb_facility_id, authz.member_id as pb_member_id, authz.resource_id as pb_resource_id, \" +\n-\t\t\"authz.service_id as pb_service_id, authz.service_principal_id as pb_user_id, authz.security_team_id as pb_security_team_id, \" +\n-\t\t\"authz.sponsored_user_id as pb_sponsored_user_id\";\n-\n-\n-\tprotected static final RowMapper<Role> AUTHZROLE_MAPPER_FOR_ATTRIBUTES = new RowMapper<Role>() {\n-\t\tpublic Role mapRow(ResultSet rs, int i) throws SQLException {\n-\t\t\tRole role = Role.valueOf(rs.getString(\"name\").toUpperCase());\n-\t\t\treturn role;\n-\t\t}\n-\t};\n-\n-\tpublic static final RowMapper<Pair<Role, Map<String, Set<Integer>>>> AUTHZROLE_MAPPER = new RowMapper<Pair<Role, Map<String, Set<Integer>>>>() {\n-\t\tpublic Pair<Role, Map<String, Set<Integer>>> mapRow(ResultSet rs, int i) throws SQLException {\n-\t\t\ttry {\n-\t\t\t\tMap<String, Set<Integer>> perunBeans = null;\n-\t\t\t\tRole role = Role.valueOf(rs.getString(\"role_name\").toUpperCase());\n-\n-\t\t\t\t// Iterate through all returned columns and try to extract PerunBean name from the labels\n-\t\t\t\tfor (int j = rs.getMetaData().getColumnCount(); j > 0; j--) {\n-\t\t\t\t\tMatcher matcher = patternForExtractingPerunBean.matcher(rs.getMetaData().getColumnLabel(j).toLowerCase());\n-\t\t\t\t\tif (matcher.find()) {\n-\t\t\t\t\t\tString perunBeanName = matcher.group(1);\n-\t\t\t\t\t\tint id = rs.getInt(j);\n-\t\t\t\t\t\tif (!rs.wasNull()) {\n-\t\t\t\t\t\t\t// We have to make first letters o words uppercase\n-\t\t\t\t\t\t\tString className = convertUnderScoreCaseToCamelCase(perunBeanName);\n-\n-\t\t\t\t\t\t\tif (perunBeans == null) {\n-\t\t\t\t\t\t\t\tperunBeans = new HashMap<String, Set<Integer>>();\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\tif (perunBeans.get(className) == null) {\n-\t\t\t\t\t\t\t\tperunBeans.put(className, new HashSet<Integer>());\n-\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\tperunBeans.get(className).add(id);\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\n-\t\t\t\treturn new Pair<Role, Map<String, Set<Integer>>>(role, perunBeans);\n-\n-\t\t\t} catch (Exception e) {\n-\t\t\t\tthrow new InternalErrorRuntimeException(e);\n-\t\t\t}\n-\t\t}\n-\t};\n-\n-\tprivate static String convertUnderScoreCaseToCamelCase(String name) {\n-\t\tboolean nextIsCapital = true;\n-\t\tStringBuilder nameBuilder = new StringBuilder();\n-\t\tfor (char c : name.toCharArray()) {\n-\t\t\tif (c == '_') {\n-\t\t\t\tnextIsCapital = true;\n-\t\t\t} else {\n-\t\t\t\tif (nextIsCapital) {\n-\t\t\t\t\tc = Character.toUpperCase(c);\n-\t\t\t\t\tnextIsCapital = false;\n-\t\t\t\t}\n-\t\t\t\tnameBuilder.append(c);\n-\t\t\t}\n-\t\t}\n-\t\treturn nameBuilder.toString();\n-\t}\n-\n-\tpublic AuthzResolverImpl(DataSource perunPool) {\n-\t\tjdbc = new JdbcPerunTemplate(perunPool);\n-\t}\n-\n-\tpublic AuthzRoles getRoles(User user) throws InternalErrorException {\n-\t\tAuthzRoles authzRoles = new AuthzRoles();\n-\n-\t\tif (user != null) {\n-\t\t\ttry {\n-\t\t\t\t// Get roles from Authz table\n-\t\t\t\tList<Pair<Role, Map<String, Set<Integer>>>> authzRolesPairs = jdbc.query(\"select \" + authzRoleMappingSelectQuery\n-\t\t\t\t\t\t+ \", roles.name as role_name from authz left join roles on authz.role_id=roles.id where authz.user_id=? or authorized_group_id in \"\n-\t\t\t\t\t\t+ \"(select groups.id from groups join groups_members on groups.id=groups_members.group_id join members on \"\n-\t\t\t\t\t\t+ \"members.id=groups_members.member_id join users on users.id=members.user_id where users.id=?)\", AUTHZROLE_MAPPER, user.getId(), user.getId());\n-\n-\t\t\t\tfor (Pair<Role, Map<String, Set<Integer>>> pair : authzRolesPairs) {\n-\t\t\t\t\tauthzRoles.putAuthzRoles(pair.getLeft(), pair.getRight());\n-\t\t\t\t}\n-\n-\t\t\t\t// Get service users for user\n-\t\t\t\tList<Integer> authzServiceUsers = jdbc.query(\"select specific_user_users.specific_user_id as id from users, \" +\n-\t\t\t\t\t\t\"specific_user_users where users.id=specific_user_users.user_id and specific_user_users.status='0' and users.id=? \" +\n-\t\t\t\t        \"and specific_user_users.type=?\", Utils.ID_MAPPER ,user.getId(), SpecificUserType.SERVICE.getSpecificUserType());\n-\t\t\t\tfor (Integer serviceUserId : authzServiceUsers) {\n-\t\t\t\t\tauthzRoles.putAuthzRole(Role.SELF, User.class, serviceUserId);\n-\t\t\t\t}\n-\n-\t\t\t\t// Get members for user\n-\t\t\t\tList<Integer> authzMember = jdbc.query(\"select members.id as id from members where members.user_id=?\",\n-\t\t\t\t\t\tUtils.ID_MAPPER ,user.getId());\n-\t\t\t\tfor (Integer memberId : authzMember) {\n-\t\t\t\t\tauthzRoles.putAuthzRole(Role.SELF, Member.class, memberId);\n-\t\t\t\t}\n-\n-\t\t\t} catch (RuntimeException e) {\n-\t\t\t\tthrow new InternalErrorException(e);\n-\t\t\t}\n-\t\t}\n-\n-\t\treturn authzRoles;\n-\t}\n-\n-\tpublic void initialize() throws InternalErrorException {\n-\n-\t\tif(perun.isPerunReadOnly()) log.debug(\"Loading authzresolver manager init in readOnly version.\");\n-\n-\t\t// Check if all roles defined in class Role exists in the DB\n-\t\tfor (Role role: Role.values()) {\n-\t\t\ttry {\n-\t\t\t\tif (0 == jdbc.queryForInt(\"select count(*) from roles where name=?\", role.getRoleName())) {\n-\t\t\t\t\t//Skip creating not existing roles for read only Perun\n-\t\t\t\t\tif(perun.isPerunReadOnly()) {\n-\t\t\t\t\t\tthrow new InternalErrorException(\"One of deafult roles not exists in DB - \" + role);\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tint newId = Utils.getNewId(jdbc, \"roles_id_seq\");\n-\t\t\t\t\t\tjdbc.update(\"insert into roles (id, name) values (?,?)\", newId, role.getRoleName());\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\t\t\t} catch (RuntimeException e) {\n-\t\t\t\tthrow new InternalErrorException(e);\n-\t\t\t}\n-\t\t}\n-\t}\n-\n-\tpublic static List<Role> getRolesWhichCanWorkWithAttribute(PerunSession sess, ActionType actionType, AttributeDefinition attrDef) throws InternalErrorException {\n-\t\tString actType = actionType.getActionType().toLowerCase();\n-\t\ttry {\n-\t\t\treturn jdbc.query(\"select distinct roles.name from attributes_authz \" +\n-\t\t\t\t\t\"join roles on attributes_authz.role_id=roles.id \" +\n-\t\t\t\t\t\"join action_types on attributes_authz.action_type_id=action_types.id \" +\n-\t\t\t\t\t\"where attributes_authz.attr_id=? and action_types.action_type=?\", AUTHZROLE_MAPPER_FOR_ATTRIBUTES, attrDef.getId(), actType);\n-\t\t} catch (EmptyResultDataAccessException e) {\n-\t\t\treturn new ArrayList<Role>();\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAllUserAuthz(PerunSession sess, User user) throws InternalErrorException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"delete from authz where user_id=?\", user.getId());\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAllSponsoredUserAuthz(PerunSession sess, User sponsoredUser) throws InternalErrorException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"delete from authz where sponsored_user_id=?\", sponsoredUser.getId());\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAllGroupAuthz(PerunSession sess, Group group) throws InternalErrorException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"delete from authz where authorized_group_id=?\", group.getId());\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAllAuthzForVo(PerunSession sess, Vo vo) throws InternalErrorException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"delete from authz where vo_id=?\", vo.getId());\n-\t\t} catch (RuntimeException err) {\n-\t\t\tthrow new InternalErrorException(err);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAllAuthzForGroup(PerunSession sess, Group group) throws InternalErrorException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"delete from authz where group_id=?\", group.getId());\n-\t\t} catch (RuntimeException err) {\n-\t\t\tthrow new InternalErrorException(err);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAllAuthzForFacility(PerunSession sess, Facility facility) throws InternalErrorException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"delete from authz where facility_id=?\", facility.getId());\n-\t\t} catch (RuntimeException err) {\n-\t\t\tthrow new InternalErrorException(err);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAllAuthzForResource(PerunSession sess, Resource resource) throws InternalErrorException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"delete from authz where resource_id=?\", resource.getId());\n-\t\t} catch (RuntimeException err) {\n-\t\t\tthrow new InternalErrorException(err);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAllAuthzForService(PerunSession sess, Service service) throws InternalErrorException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"delete from authz where service_id=?\", service.getId());\n-\t\t} catch (RuntimeException err) {\n-\t\t\tthrow new InternalErrorException(err);\n-\t\t}\n-\t}\n-\n-\t@Override\n-\tpublic void removeAllAuthzForSecurityTeam(PerunSession sess, SecurityTeam securityTeam) throws InternalErrorException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"delete from authz where security_team_id=?\", securityTeam.getId());\n-\t\t} catch (RuntimeException err) {\n-\t\t\tthrow new InternalErrorException(err);\n-\t\t}\n-\t}\n-\n-\tpublic void addAdmin(PerunSession sess, Facility facility, User user) throws InternalErrorException, AlreadyAdminException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"insert into authz (user_id, role_id, facility_id) values (?, (select id from roles where name=?), ?)\", user.getId(), Role.FACILITYADMIN.getRoleName(), facility.getId());\n-\t\t} catch (DataIntegrityViolationException e) {\n-\t\t\tthrow new AlreadyAdminException(\"User id=\" + user.getId() + \" is already admin of the facility \" + facility, e, user, facility);\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void addAdmin(PerunSession sess, Facility facility, Group group) throws InternalErrorException, AlreadyAdminException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"insert into authz (authorized_group_id, role_id, facility_id) values (?, (select id from roles where name=?), ?)\", group.getId(), Role.FACILITYADMIN.getRoleName(), facility.getId());\n-\t\t} catch (DataIntegrityViolationException e) {\n-\t\t\tthrow new AlreadyAdminException(\"Group id=\" + group.getId() + \" is already admin of the facility \" + facility, e, group, facility);\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAdmin(PerunSession sess, Facility facility, User user) throws InternalErrorException, UserNotAdminException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where user_id=? and facility_id=? and role_id=(select id from roles where name=?)\", user.getId(), facility.getId(), Role.FACILITYADMIN.getRoleName())) {\n-\t\t\t\tthrow new UserNotAdminException(\"User id=\" + user.getId() + \" is not admin of the facility \" + facility);\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAdmin(PerunSession sess, Facility facility, Group group) throws InternalErrorException, GroupNotAdminException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where authorized_group_id=? and facility_id=? and role_id=(select id from roles where name=?)\", group.getId(), facility.getId(), Role.FACILITYADMIN.getRoleName())) {\n-\t\t\t\tthrow new GroupNotAdminException(\"Group id=\" + group.getId() + \" is not admin of the facility \" + facility);\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void addAdmin(PerunSession sess, User sponsoredUser, User user) throws InternalErrorException, AlreadyAdminException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"insert into authz (user_id, role_id, sponsored_user_id) values (?, (select id from roles where name=?), ?)\", user.getId(), Role.SPONSOR.getRoleName(), sponsoredUser.getId());\n-\t\t} catch (DataIntegrityViolationException e) {\n-\t\t\tthrow new AlreadyAdminException(\"User id=\" + user.getId() + \" is already sponsor of the sponsoredUser \" + sponsoredUser, e, user, sponsoredUser);\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void addAdmin(PerunSession sess, User sponsoredUser, Group group) throws InternalErrorException, AlreadyAdminException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"insert into authz (authorized_group_id, role_id, sponsored_user_id) values (?, (select id from roles where name=?), ?)\", group.getId(), Role.SPONSOR.getRoleName(), sponsoredUser.getId());\n-\t\t} catch (DataIntegrityViolationException e) {\n-\t\t\tthrow new AlreadyAdminException(\"Group id=\" + group.getId() + \" is already sponsor of the sponsoredUser \" + sponsoredUser, e, group, sponsoredUser);\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAdmin(PerunSession sess, User sponsoredUser, User user) throws InternalErrorException, UserNotAdminException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where user_id=? and sponsored_user_id=? and role_id=(select id from roles where name=?)\", user.getId(), sponsoredUser.getId(), Role.SPONSOR.getRoleName())) {\n-\t\t\t\tthrow new UserNotAdminException(\"User id=\" + user.getId() + \" is not sponsor of the sponsored user \" + sponsoredUser);\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAdmin(PerunSession sess, User sponsoredUser, Group group) throws InternalErrorException, GroupNotAdminException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where authorized_group_id=? and sponsored_user_id=? and role_id=(select id from roles where name=?)\", group.getId(), sponsoredUser.getId(), Role.SPONSOR.getRoleName())) {\n-\t\t\t\tthrow new GroupNotAdminException(\"Group id=\" + group.getId() + \" is not sponsor of the sponsored user \" + sponsoredUser);\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void addAdmin(PerunSession sess, Group group, User user) throws InternalErrorException, AlreadyAdminException {\n-\t\ttry {\n-\t\t\t// Add GROUPADMIN role + groupId and voId\n-\t\t\tjdbc.update(\"insert into authz (user_id, role_id, group_id, vo_id) values (?, (select id from roles where name=?), ?, ?)\",\n-\t\t\t\t\tuser.getId(), Role.GROUPADMIN.getRoleName(), group.getId(), group.getVoId());\n-\t\t} catch (DataIntegrityViolationException e) {\n-\t\t\tthrow new AlreadyAdminException(\"User id=\" + user.getId() + \" is already admin in group \" + group, e, user, group);\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void addAdmin(PerunSession sess, Group group, Group authorizedGroup) throws InternalErrorException, AlreadyAdminException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"insert into authz (authorized_group_id, role_id, group_id, vo_id) values (?, (select id from roles where name=?), ?, ?)\",\n-\t\t\t\t\tauthorizedGroup.getId(), Role.GROUPADMIN.getRoleName(), group.getId(), group.getVoId());\n-\t\t} catch (DataIntegrityViolationException e) {\n-\t\t\tthrow new AlreadyAdminException(\"Group id=\" + authorizedGroup.getId() + \" is already group admin in group \" + group, e, authorizedGroup, group);\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAdmin(PerunSession sess, Group group, User user) throws InternalErrorException, UserNotAdminException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where user_id=? and group_id=? and role_id=(select id from roles where name=?)\",\n-\t\t\t\t\t\tuser.getId(), group.getId(), Role.GROUPADMIN.getRoleName())) {\n-\t\t\t\tthrow new UserNotAdminException(\"User id=\" + user.getId() + \" is not admin of the group \" + group);\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAdmin(PerunSession sess, Group group, Group authorizedGroup) throws InternalErrorException, GroupNotAdminException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where authorized_group_id=? and group_id=? and role_id=(select id from roles where name=?)\",\n-\t\t\t\t\t\tauthorizedGroup.getId(), group.getId(), Role.GROUPADMIN.getRoleName())) {\n-\t\t\t\tthrow new GroupNotAdminException(\"Group id=\" + authorizedGroup.getId() + \" is not admin of the group \" + group);\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void addAdmin(PerunSession sess, Vo vo, User user) throws InternalErrorException, AlreadyAdminException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"insert into authz (user_id, role_id, vo_id) values (?, (select id from roles where name=?), ?)\", user.getId(),\n-\t\t\t\t\tRole.VOADMIN.getRoleName(), vo.getId());\n-\t\t} catch (DataIntegrityViolationException e) {\n-\t\t\tthrow new AlreadyAdminException(\"User id=\" + user.getId() + \" is already admin in vo \" + vo, e, user, vo);\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void addAdmin(PerunSession sess, Vo vo, Group group) throws InternalErrorException, AlreadyAdminException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"insert into authz (role_id, vo_id, authorized_group_id) values ((select id from roles where name=?), ?, ?)\",\n-\t\t\t\t\tRole.VOADMIN.getRoleName(), vo.getId(), group.getId());\n-\t\t} catch (DataIntegrityViolationException e) {\n-\t\t\tthrow new AlreadyAdminException(\"Group id=\" + group.getId() + \" is already admin in vo \" + vo, e, group, vo);\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\t@Override\n-\tpublic void addAdmin(PerunSession sess, SecurityTeam securityTeam, User user) throws AlreadyAdminException, InternalErrorException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"insert into authz (user_id, role_id, security_team_id) values (?, (select id from roles where name=?), ?)\", user.getId(),\n-\t\t\t\t\tRole.SECURITYADMIN.getRoleName(), securityTeam.getId());\n-\t\t} catch (DataIntegrityViolationException e) {\n-\t\t\tthrow new AlreadyAdminException(\"User id=\" + user.getId() + \" is already admin in securityTeam \" + securityTeam, e, user, securityTeam);\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\t@Override\n-\tpublic void addAdmin(PerunSession sess, SecurityTeam securityTeam, Group group) throws AlreadyAdminException, InternalErrorException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"insert into authz (authorized_group_id, role_id, security_team_id) values (?, (select id from roles where name=?), ?)\", group.getId(),\n-\t\t\t\t\tRole.SECURITYADMIN.getRoleName(), securityTeam.getId());\n-\t\t} catch (DataIntegrityViolationException e) {\n-\t\t\tthrow new AlreadyAdminException(\"Group id=\" + group.getId() + \" is already admin in securityTeam \" + securityTeam, e, group, securityTeam);\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void addObserver(PerunSession sess, Vo vo, User user) throws InternalErrorException, AlreadyAdminException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"insert into authz (user_id, role_id, vo_id) values (?, (select id from roles where name=?), ?)\", user.getId(),\n-\t\t\t\t\tRole.VOOBSERVER.getRoleName(), vo.getId());\n-\t\t} catch (DataIntegrityViolationException e) {\n-\t\t\tthrow new AlreadyAdminException(\"User id=\" + user.getId() + \" is already observer in vo \" + vo, e, user, vo);\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void addObserver(PerunSession sess, Vo vo, Group group) throws InternalErrorException, AlreadyAdminException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"insert into authz (role_id, vo_id, authorized_group_id) values ((select id from roles where name=?), ?, ?)\",\n-\t\t\t\t\tRole.VOOBSERVER.getRoleName(), vo.getId(), group.getId());\n-\t\t} catch (DataIntegrityViolationException e) {\n-\t\t\tthrow new AlreadyAdminException(\"Group id=\" + group.getId() + \" is already observer in vo \" + vo, e, group, vo);\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void addTopGroupCreator(PerunSession sess, Vo vo, User user) throws InternalErrorException, AlreadyAdminException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"insert into authz (user_id, role_id, vo_id) values (?, (select id from roles where name=?), ?)\", user.getId(),\n-\t\t\t\t\tRole.TOPGROUPCREATOR.getRoleName(), vo.getId());\n-\t\t} catch (DataIntegrityViolationException e) {\n-\t\t\tthrow new AlreadyAdminException(\"User id=\" + user.getId() + \" is already observer in vo \" + vo, e, user, vo);\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void addTopGroupCreator(PerunSession sess, Vo vo, Group group) throws InternalErrorException, AlreadyAdminException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"insert into authz (role_id, vo_id, authorized_group_id) values ((select id from roles where name=?), ?, ?)\",\n-\t\t\t\t\tRole.TOPGROUPCREATOR.getRoleName(), vo.getId(), group.getId());\n-\t\t} catch (DataIntegrityViolationException e) {\n-\t\t\tthrow new AlreadyAdminException(\"Group id=\" + group.getId() + \" is already observer in vo \" + vo, e, group, vo);\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeObserver(PerunSession sess, Vo vo, User user) throws InternalErrorException, UserNotAdminException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where user_id=? and vo_id=? and role_id=(select id from roles where name=?)\", user.getId(), vo.getId(), Role.VOOBSERVER.getRoleName())) {\n-\t\t\t\tthrow new UserNotAdminException(\"User id=\" + user.getId() + \" is not observer of the vo \" + vo);\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeObserver(PerunSession sess, Vo vo, Group group) throws InternalErrorException, GroupNotAdminException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where authorized_group_id=? and vo_id=? and role_id=(select id from roles where name=?)\", group.getId(), vo.getId(), Role.VOOBSERVER.getRoleName())) {\n-\t\t\t\tthrow new GroupNotAdminException(\"Group id=\" + group.getId() + \" is not observer of the vo \" + vo);\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeTopGroupCreator(PerunSession sess, Vo vo, User user) throws InternalErrorException, UserNotAdminException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where user_id=? and vo_id=? and role_id=(select id from roles where name=?)\", user.getId(), vo.getId(), Role.TOPGROUPCREATOR.getRoleName())) {\n-\t\t\t\tthrow new UserNotAdminException(\"User id=\" + user.getId() + \" is not observer of the vo \" + vo);\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeTopGroupCreator(PerunSession sess, Vo vo, Group group) throws InternalErrorException, GroupNotAdminException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where authorized_group_id=? and vo_id=? and role_id=(select id from roles where name=?)\", group.getId(), vo.getId(), Role.TOPGROUPCREATOR.getRoleName())) {\n-\t\t\t\tthrow new GroupNotAdminException(\"Group id=\" + group.getId() + \" is not observer of the vo \" + vo);\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAdmin(PerunSession sess, Vo vo, User user) throws InternalErrorException, UserNotAdminException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where user_id=? and vo_id=? and role_id=(select id from roles where name=?)\", user.getId(), vo.getId(), Role.VOADMIN.getRoleName())) {\n-\t\t\t\tthrow new UserNotAdminException(\"User id=\" + user.getId() + \" is not admin of the vo \" + vo);\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removeAdmin(PerunSession sess, Vo vo, Group group) throws InternalErrorException, GroupNotAdminException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where authorized_group_id=? and vo_id=? and role_id=(select id from roles where name=?)\", group.getId(), vo.getId(), Role.VOADMIN.getRoleName())) {\n-\t\t\t\tthrow new GroupNotAdminException(\"Group id=\" + group.getId() + \" is not admin of the vo \" + vo);\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\t@Override\n-\tpublic void removeAdmin(PerunSession sess, SecurityTeam securityTeam, User user) throws UserNotAdminException, InternalErrorException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where user_id=? and security_team_id=? and role_id=(select id from roles where name=?)\", user.getId(), securityTeam.getId(), Role.SECURITYADMIN.getRoleName())) {\n-\t\t\t\tthrow new UserNotAdminException(\"User id=\" + user.getId() + \" is not admin of the security team \" + securityTeam);\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\t@Override\n-\tpublic void removeAdmin(PerunSession sess, SecurityTeam securityTeam, Group group) throws GroupNotAdminException, InternalErrorException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where authorized_group_id=? and security_team_id=? and role_id=(select id from roles where name=?)\", group.getId(), securityTeam.getId(), Role.SECURITYADMIN.getRoleName())) {\n-\t\t\t\tthrow new GroupNotAdminException(\"Group id=\" + group.getId() + \" is not admin of the security team \" + securityTeam);\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void makeUserPerunAdmin(PerunSession sess, User user) throws InternalErrorException {\n-\t\ttry {\n-\t\t\tjdbc.update(\"insert into authz (user_id, role_id) values (?, (select id from roles where name=?))\", user.getId(), Role.PERUNADMIN.getRoleName());\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void removePerunAdmin(PerunSession sess, User user) throws InternalErrorException, UserNotAdminException {\n-\t\ttry {\n-\t\t\tif (0 == jdbc.update(\"delete from authz where user_id=? and role_id=(select id from roles where name=?)\", user.getId(), Role.PERUNADMIN.getRoleName())) {\n-\t\t\t\tthrow new UserNotAdminException(\"User id=\" + user.getId() + \" is not perun admin.\");\n-\t\t\t}\n-\t\t} catch (RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(e);\n-\t\t}\n-\t}\n-\n-\tpublic void setPerun(Perun perun) {\n-\t\tthis.perun = perun;\n-\t}\n-}\n+ final static Logger log = LoggerFactory.getLogger(FacilitiesManagerImpl.class);\n+\n+ //http://static.springsource.org/spring/docs/3.0.x/spring-framework-reference/html/jdbc.html\n+ private static JdbcPerunTemplate jdbc;\n+ private Perun perun;\n+ private final static Pattern patternForExtractingPerunBean = Pattern.compile(\"^pb_([a-z_]+)_id$\");\n+\n+ public final static String authzRoleMappingSelectQuery = \" authz.user_id as authz_user_id, authz.role_id as authz_role_id,\" + \"authz.authorized_group_id as authz_authorized_group_id, authz.vo_id as pb_vo_id, authz.group_id as pb_group_id, \" + \"authz.facility_id as pb_facility_id, authz.member_id as pb_member_id, authz.resource_id as pb_resource_id, \" + \"authz.service_id as pb_service_id, authz.service_principal_id as pb_user_id, authz.security_team_id as pb_security_team_id, \" + \"authz.sponsored_user_id as pb_sponsored_user_id\";\n+\n+\n+ protected static final RowMapper<Role> AUTHZROLE_MAPPER_FOR_ATTRIBUTES = new RowMapper<Role>() {\n+                                         public Role mapRow(ResultSet rs, int i) throws SQLException {\n+                                          Role role = Role.valueOf(rs.getString(\"name\").toUpperCase());\n+                                          return role;\n+                                         }\n+                                        };\n+\n+ public static final RowMapper<Pair<Role, Map<String, Set<Integer>>>> AUTHZROLE_MAPPER = new RowMapper<Pair<Role, Map<String, Set<Integer>>>>() {\n+                                                                       public Pair<Role, Map<String, Set<Integer>>> mapRow(ResultSet rs, int i) throws SQLException {\n+                                                                        try {\n+                                                                         Map<String, Set<Integer>> perunBeans = null;\n+                                                                         Role role = Role.valueOf(rs.getString(\"role_name\").toUpperCase());\n+\n+    // Iterate through all returned columns and try to extract PerunBean name from the labels\n+                                                                         for (int j = rs.getMetaData().getColumnCount(); j > 0; j--) {\n+                                                                          Matcher matcher = patternForExtractingPerunBean.matcher(rs.getMetaData().getColumnLabel(j).toLowerCase());\n+                                                                          if (matcher.find()) {\n+                                                                           String perunBeanName = matcher.group(1);\n+                                                                           int id = rs.getInt(j);\n+                                                                           if (!rs.wasNull()) {\n+       // We have to make first letters o words uppercase\n+                                                                            String className = convertUnderScoreCaseToCamelCase(perunBeanName);\n+                                                                            if (perunBeans == null) {\n+                                                                             perunBeans = new HashMap<String, Set<Integer>>();\n+                                                                            }\n+                                                                            if (perunBeans.get(className) == null) {\n+                                                                             perunBeans.put(className, new HashSet<Integer>());\n+                                                                            }\n+                                                                            perunBeans.get(className).add(id);\n+                                                                           }\n+                                                                          }\n+                                                                         }\n+\n+                                                                         return new Pair<Role, Map<String, Set<Integer>>>(role, perunBeans);\n+                                                                        } catch (Exception e) {\n+                                                                         throw new InternalErrorRuntimeException(e);\n+                                                                        }\n+                                                                       }\n+                                                                      };\n+ private static String convertUnderScoreCaseToCamelCase(String name) {\n+\n+  boolean nextIsCapital = true;\n+  StringBuilder nameBuilder = new StringBuilder();\n+  for (char c : name.toCharArray()) {\n+   if (c == '_') {\n+    nextIsCapital = true;\n+   } else {\n+    if (nextIsCapital) {\n+     c = Character.toUpperCase(c);\n+     nextIsCapital = false;\n+    }\n+    nameBuilder.append(c);\n+   }\n+  }\n+\n+  return nameBuilder.toString();\n+ }\n+\n+\n+ public AuthzResolverImpl(DataSource perunPool) {\n+  jdbc = new JdbcPerunTemplate(perunPool);\n+ }\n+\n+ public AuthzRoles getRoles(User user) throws InternalErrorException {\n+  AuthzRoles authzRoles = new AuthzRoles();\n+  if (user != null) {\n+   try {\n+    // Get roles from Authz table\n+    List<Pair<Role, Map<String, Set<Integer>>>> authzRolesPairs = jdbc.query(\"select \" + authzRoleMappingSelectQuery + \", roles.name as role_name from authz left join roles on authz.role_id=roles.id where authz.user_id=? or authorized_group_id in \" + \"(select groups.id from groups join groups_members on groups.id=groups_members.group_id join members on \" + \"members.id=groups_members.member_id join users on users.id=members.user_id where users.id=?)\", AUTHZROLE_MAPPER, user.getId(), user.getId());\n+    for (Pair<Role, Map<String, Set<Integer>>> pair : authzRolesPairs) {\n+     authzRoles.putAuthzRoles(pair.getLeft(), pair.getRight());\n+    }\n+\n+    // Get service users for user\n+    List<Integer> authzServiceUsers = jdbc.query(\"select specific_user_users.specific_user_id as id from users, \" + \"specific_user_users where users.id=specific_user_users.user_id and specific_user_users.status='0' and users.id=? \" + \"and specific_user_users.type=?\", Utils.ID_MAPPER, user.getId(), SpecificUserType.SERVICE.getSpecificUserType());\n+    for (Integer serviceUserId : authzServiceUsers) {\n+     authzRoles.putAuthzRole(Role.SELF, User.class, serviceUserId);\n+    }\n+\n+    // Get members for user\n+    List<Integer> authzMember = jdbc.query(\"select members.id as id from members where members.user_id=?\", Utils.ID_MAPPER, user.getId());\n+    for (Integer memberId : authzMember) {\n+     authzRoles.putAuthzRole(Role.SELF, Member.class, memberId);\n+    }\n+   } catch (RuntimeException e) {\n+    throw new InternalErrorException(e);\n+   }\n+  }\n+\n+  return authzRoles;\n+ }\n+\n+ public void initialize() throws InternalErrorException {\n+  if (perun.isPerunReadOnly()) log.debug(\"Loading authzresolver manager init in readOnly version.\");\n+\n+  // Check if all roles defined in class Role exists in the DB\n+  for (Role role : Role.values()) {\n+   try {\n+    if (0 == jdbc.queryForInt(\"select count(*) from roles where name=?\", role.getRoleName())) {\n+     //Skip creating not existing roles for read only Perun\n+     if (perun.isPerunReadOnly()) {\n+      throw new InternalErrorException(\"One of deafult roles not exists in DB - \" + role);\n+     } else {\n+      int newId = Utils.getNewId(jdbc, \"roles_id_seq\");\n+      jdbc.update(\"insert into roles (id, name) values (?,?)\", newId, role.getRoleName());\n+     }\n+    }\n+   } catch (RuntimeException e) {\n+    throw new InternalErrorException(e);\n+   }\n+  }\n+ }\n+\n+ public static List<Role> getRolesWhichCanWorkWithAttribute(PerunSession sess, ActionType actionType, AttributeDefinition attrDef) throws InternalErrorException {\n+  String actType = actionType.getActionType().toLowerCase();\n+  try {\n+   return jdbc.query(\"select distinct roles.name from attributes_authz \" + \"join roles on attributes_authz.role_id=roles.id \" + \"join action_types on attributes_authz.action_type_id=action_types.id \" + \"where attributes_authz.attr_id=? and action_types.action_type=?\", AUTHZROLE_MAPPER_FOR_ATTRIBUTES, attrDef.getId(), actType);\n+  } catch (EmptyResultDataAccessException e) {\n+   return new ArrayList<Role>();\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void removeAllUserAuthz(PerunSession sess, User user) throws InternalErrorException {\n+  try {\n+   jdbc.update(\"delete from authz where user_id=?\", user.getId());\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void removeAllSponsoredUserAuthz(PerunSession sess, User sponsoredUser) throws InternalErrorException {\n+  try {\n+   jdbc.update(\"delete from authz where sponsored_user_id=?\", sponsoredUser.getId());\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void removeAllGroupAuthz(PerunSession sess, Group group) throws InternalErrorException {\n+  try {\n+   jdbc.update(\"delete from authz where authorized_group_id=?\", group.getId());\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void removeAllAuthzForVo(PerunSession sess, Vo vo) throws InternalErrorException {\n+  try {\n+   jdbc.update(\"delete from authz where vo_id=?\", vo.getId());\n+  } catch (RuntimeException err) {\n+   throw new InternalErrorException(err);\n+  }\n+ }\n+\n+ public void removeAllAuthzForGroup(PerunSession sess, Group group) throws InternalErrorException {\n+  try {\n+   jdbc.update(\"delete from authz where group_id=?\", group.getId());\n+  } catch (RuntimeException err) {\n+   throw new InternalErrorException(err);\n+  }\n+ }\n+\n+ public void removeAllAuthzForFacility(PerunSession sess, Facility facility) throws InternalErrorException {\n+  try {\n+   jdbc.update(\"delete from authz where facility_id=?\", facility.getId());\n+  } catch (RuntimeException err) {\n+   throw new InternalErrorException(err);\n+  }\n+ }\n+\n+ public void removeAllAuthzForResource(PerunSession sess, Resource resource) throws InternalErrorException {\n+  try {\n+   jdbc.update(\"delete from authz where resource_id=?\", resource.getId());\n+  } catch (RuntimeException err) {\n+   throw new InternalErrorException(err);\n+  }\n+ }\n+\n+ public void removeAllAuthzForService(PerunSession sess, Service service) throws InternalErrorException {\n+  try {\n+   jdbc.update(\"delete from authz where service_id=?\", service.getId());\n+  } catch (RuntimeException err) {\n+   throw new InternalErrorException(err);\n+  }\n+ }\n+\n+ @Override\n+ public void removeAllAuthzForSecurityTeam(PerunSession sess, SecurityTeam securityTeam) throws InternalErrorException {\n+  try {\n+   jdbc.update(\"delete from authz where security_team_id=?\", securityTeam.getId());\n+  } catch (RuntimeException err) {\n+   throw new InternalErrorException(err);\n+  }\n+ }\n+\n+ public void addAdmin(PerunSession sess, Facility facility, User user) throws InternalErrorException, AlreadyAdminException {\n+  try {\n+   jdbc.update(\"insert into authz (user_id, role_id, facility_id) values (?, (select id from roles where name=?), ?)\", user.getId(), Role.FACILITYADMIN.getRoleName(), facility.getId());\n+  } catch (DataIntegrityViolationException e) {\n+   throw new AlreadyAdminException(\"User id=\" + user.getId() + \" is already admin of the facility \" + facility, e, user, facility);\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void addAdmin(PerunSession sess, Facility facility, Group group) throws InternalErrorException, AlreadyAdminException {\n+  try {\n+   jdbc.update(\"insert into authz (authorized_group_id, role_id, facility_id) values (?, (select id from roles where name=?), ?)\", group.getId(), Role.FACILITYADMIN.getRoleName(), facility.getId());\n+  } catch (DataIntegrityViolationException e) {\n+   throw new AlreadyAdminException(\"Group id=\" + group.getId() + \" is already admin of the facility \" + facility, e, group, facility);\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void removeAdmin(PerunSession sess, Facility facility, User user) throws InternalErrorException, UserNotAdminException {\n+  try {\n+   if (0 == jdbc.update(\"delete from authz where user_id=? and facility_id=? and role_id=(select id from roles where name=?)\", user.getId(), facility.getId(), Role.FACILITYADMIN.getRoleName())) {\n+    throw new UserNotAdminException(\"User id=\" + user.getId() + \" is not admin of the facility \" + facility);\n+   }\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void removeAdmin(PerunSession sess, Facility facility, Group group) throws InternalErrorException, GroupNotAdminException {\n+  try {\n+   if (0 == jdbc.update(\"delete from authz where authorized_group_id=? and facility_id=? and role_id=(select id from roles where name=?)\", group.getId(), facility.getId(), Role.FACILITYADMIN.getRoleName())) {\n+    throw new GroupNotAdminException(\"Group id=\" + group.getId() + \" is not admin of the facility \" + facility);\n+   }\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void addAdmin(PerunSession sess, User sponsoredUser, User user) throws InternalErrorException, AlreadyAdminException {\n+  try {\n+   jdbc.update(\"insert into authz (user_id, role_id, sponsored_user_id) values (?, (select id from roles where name=?), ?)\", user.getId(), Role.SPONSOR.getRoleName(), sponsoredUser.getId());\n+  } catch (DataIntegrityViolationException e) {\n+   throw new AlreadyAdminException(\"User id=\" + user.getId() + \" is already sponsor of the sponsoredUser \" + sponsoredUser,\n+e,\n+user,\n+sponsoredUser);\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void addAdmin(PerunSession sess, User sponsoredUser, Group group) throws InternalErrorException, AlreadyAdminException {\n+  try {\n+   jdbc.update(\"insert into authz (authorized_group_id, role_id, sponsored_user_id) values (?, (select id from roles where name=?), ?)\", group.getId(), Role.SPONSOR.getRoleName(), sponsoredUser.getId());\n+  } catch (DataIntegrityViolationException e) {\n+   throw new AlreadyAdminException(\"Group id=\" + group.getId() + \" is already sponsor of the sponsoredUser \" + sponsoredUser,\n+e,\n+group,\n+sponsoredUser);\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void removeAdmin(PerunSession sess, User sponsoredUser, User user) throws InternalErrorException, UserNotAdminException {\n+  try {\n+   if (0 == jdbc.update(\"delete from authz where user_id=? and sponsored_user_id=? and role_id=(select id from roles where name=?)\", user.getId(), sponsoredUser.getId(), Role.SPONSOR.getRoleName())) {\n+    throw new UserNotAdminException(\"User id=\" + user.getId() + \" is not sponsor of the sponsored user \" + sponsoredUser);\n+   }\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void removeAdmin(PerunSession sess, User sponsoredUser, Group group) throws InternalErrorException, GroupNotAdminException {\n+  try {\n+   if (0 == jdbc.update(\"delete from authz where authorized_group_id=? and sponsored_user_id=? and role_id=(select id from roles where name=?)\", group.getId(), sponsoredUser.getId(), Role.SPONSOR.getRoleName())) {\n+    throw new GroupNotAdminException(\"Group id=\" + group.getId() + \" is not sponsor of the sponsored user \" + sponsoredUser);\n+   }\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void addAdmin(PerunSession sess, Group group, User user) throws InternalErrorException, AlreadyAdminException {\n+  try {\n+   // Add GROUPADMIN role + groupId and voId\n+   jdbc.update(\"insert into authz (user_id, role_id, group_id, vo_id) values (?, (select id from roles where name=?), ?, ?)\", user.getId(), Role.GROUPADMIN.getRoleName(), group.getId(), group.getVoId());\n+  } catch (DataIntegrityViolationException e) {\n+   throw new AlreadyAdminException(\"User id=\" + user.getId() + \" is already admin in group \" + group, e, user, group);\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void addAdmin(PerunSession sess, Group group, Group authorizedGroup) throws InternalErrorException, AlreadyAdminException {\n+  try {\n+   jdbc.update(\"insert into authz (authorized_group_id, role_id, group_id, vo_id) values (?, (select id from roles where name=?), ?, ?)\", authorizedGroup.getId(), Role.GROUPADMIN.getRoleName(), group.getId(), group.getVoId());\n+  } catch (DataIntegrityViolationException e) {\n+   throw new AlreadyAdminException(\"Group id=\" + authorizedGroup.getId() + \" is already group admin in group \" + group, e, authorizedGroup, group);\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void removeAdmin(PerunSession sess, Group group, User user) throws InternalErrorException, UserNotAdminException {\n+  try {\n+   if (0 == jdbc.update(\"delete from authz where user_id=? and group_id=? and role_id=(select id from roles where name=?)\", user.getId(), group.getId(), Role.GROUPADMIN.getRoleName())) {\n+    throw new UserNotAdminException(\"User id=\" + user.getId() + \" is not admin of the group \" + group);\n+   }\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void removeAdmin(PerunSession sess, Group group, Group authorizedGroup) throws InternalErrorException, GroupNotAdminException {\n+  try {\n+   if (0 == jdbc.update(\"delete from authz where authorized_group_id=? and group_id=? and role_id=(select id from roles where name=?)\", authorizedGroup.getId(), group.getId(), Role.GROUPADMIN.getRoleName())) {\n+    throw new GroupNotAdminException(\"Group id=\" + authorizedGroup.getId() + \" is not admin of the group \" + group);\n+   }\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void addAdmin(PerunSession sess, Vo vo, User user) throws InternalErrorException, AlreadyAdminException {\n+  try {\n+   jdbc.update(\"insert into authz (user_id, role_id, vo_id) values (?, (select id from roles where name=?), ?)\", user.getId(), Role.VOADMIN.getRoleName(), vo.getId());\n+  } catch (DataIntegrityViolationException e) {\n+   throw new AlreadyAdminException(\"User id=\" + user.getId() + \" is already admin in vo \" + vo, e, user, vo);\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void addAdmin(PerunSession sess, Vo vo, Group group) throws InternalErrorException, AlreadyAdminException {\n+  try {\n+   jdbc.update(\"insert into authz (role_id, vo_id, authorized_group_id) values ((select id from roles where name=?), ?, ?)\", Role.VOADMIN.getRoleName(), vo.getId(), group.getId());\n+  } catch (DataIntegrityViolationException e) {\n+   throw new AlreadyAdminException(\"Group id=\" + group.getId() + \" is already admin in vo \" + vo, e, group, vo);\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ @Override\n+ public void addAdmin(PerunSession sess, SecurityTeam securityTeam, User user) throws AlreadyAdminException, InternalErrorException {\n+  try {\n+   jdbc.update(\"insert into authz (user_id, role_id, security_team_id) values (?, (select id from roles where name=?), ?)\", user.getId(), Role.SECURITYADMIN.getRoleName(), securityTeam.getId());\n+  } catch (DataIntegrityViolationException e) {\n+   throw new AlreadyAdminException(\"User id=\" + user.getId() + \" is already admin in securityTeam \" + securityTeam, e, user, securityTeam);\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ @Override\n+ public void addAdmin(PerunSession sess, SecurityTeam securityTeam, Group group) throws AlreadyAdminException, InternalErrorException {\n+  try {\n+   jdbc.update(\"insert into authz (authorized_group_id, role_id, security_team_id) values (?, (select id from roles where name=?), ?)\", group.getId(), Role.SECURITYADMIN.getRoleName(), securityTeam.getId());\n+  } catch (DataIntegrityViolationException e) {\n+   throw new AlreadyAdminException(\"Group id=\" + group.getId() + \" is already admin in securityTeam \" + securityTeam, e, group, securityTeam);\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void addObserver(PerunSession sess, Vo vo, User user) throws InternalErrorException, AlreadyAdminException {\n+  try {\n+   jdbc.update(\"insert into authz (user_id, role_id, vo_id) values (?, (select id from roles where name=?), ?)\", user.getId(), Role.VOOBSERVER.getRoleName(), vo.getId());\n+  } catch (DataIntegrityViolationException e) {\n+   throw new AlreadyAdminException(\"User id=\" + user.getId() + \" is already observer in vo \" + vo, e, user, vo);\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void addObserver(PerunSession sess, Vo vo, Group group) throws InternalErrorException, AlreadyAdminException {\n+  try {\n+   jdbc.update(\"insert into authz (role_id, vo_id, authorized_group_id) values ((select id from roles where name=?), ?, ?)\", Role.VOOBSERVER.getRoleName(), vo.getId(), group.getId());\n+  } catch (DataIntegrityViolationException e) {\n+   throw new AlreadyAdminException(\"Group id=\" + group.getId() + \" is already observer in vo \" + vo, e, group, vo);\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void addTopGroupCreator(PerunSession sess, Vo vo, User user) throws InternalErrorException, AlreadyAdminException {\n+  try {\n+   jdbc.update(\"insert into authz (user_id, role_id, vo_id) values (?, (select id from roles where name=?), ?)\", user.getId(), Role.TOPGROUPCREATOR.getRoleName(), vo.getId());\n+  } catch (DataIntegrityViolationException e) {\n+   throw new AlreadyAdminException(\"User id=\" + user.getId() + \" is already observer in vo \" + vo, e, user, vo);\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void addTopGroupCreator(PerunSession sess, Vo vo, Group group) throws InternalErrorException, AlreadyAdminException {\n+  try {\n+   jdbc.update(\"insert into authz (role_id, vo_id, authorized_group_id) values ((select id from roles where name=?), ?, ?)\", Role.TOPGROUPCREATOR.getRoleName(), vo.getId(), group.getId());\n+  } catch (DataIntegrityViolationException e) {\n+   throw new AlreadyAdminException(\"Group id=\" + group.getId() + \" is already observer in vo \" + vo, e, group, vo);\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void removeObserver(PerunSession sess, Vo vo, User user) throws InternalErrorException, UserNotAdminException {\n+  try {\n+   if (0 == jdbc.update(\"delete from authz where user_id=? and vo_id=? and role_id=(select id from roles where name=?)\", user.getId(), vo.getId(), Role.VOOBSERVER.getRoleName())) {\n+    throw new UserNotAdminException(\"User id=\" + user.getId() + \" is not observer of the vo \" + vo);\n+   }\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void removeObserver(PerunSession sess, Vo vo, Group group) throws InternalErrorException, GroupNotAdminException {\n+  try {\n+   if (0 == jdbc.update(\"delete from authz where authorized_group_id=? and vo_id=? and role_id=(select id from roles where name=?)\", group.getId(), vo.getId(), Role.VOOBSERVER.getRoleName())) {\n+    throw new GroupNotAdminException(\"Group id=\" + group.getId() + \" is not observer of the vo \" + vo);\n+   }\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void removeTopGroupCreator(PerunSession sess, Vo vo, User user) throws InternalErrorException, UserNotAdminException {\n+  try {\n+   if (0 == jdbc.update(\"delete from authz where user_id=? and vo_id=? and role_id=(select id from roles where name=?)\", user.getId(), vo.getId(), Role.TOPGROUPCREATOR.getRoleName())) {\n+    throw new UserNotAdminException(\"User id=\" + user.getId() + \" is not observer of the vo \" + vo);\n+   }\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void removeTopGroupCreator(PerunSession sess, Vo vo, Group group) throws InternalErrorException, GroupNotAdminException {\n+  try {\n+   if (0 == jdbc.update(\"delete from authz where authorized_group_id=? and vo_id=? and role_id=(select id from roles where name=?)\", group.getId(), vo.getId(), Role.TOPGROUPCREATOR.getRoleName())) {\n+    throw new GroupNotAdminException(\"Group id=\" + group.getId() + \" is not observer of the vo \" + vo);\n+   }\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void removeAdmin(PerunSession sess, Vo vo, User user) throws InternalErrorException, UserNotAdminException {\n+  try {\n+   if (0 == jdbc.update(\"delete from authz where user_id=? and vo_id=? and role_id=(select id from roles where name=?)\", user.getId(), vo.getId(), Role.VOADMIN.getRoleName())) {\n+    throw new UserNotAdminException(\"User id=\" + user.getId() + \" is not admin of the vo \" + vo);\n+   }\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void removeAdmin(PerunSession sess, Vo vo, Group group) throws InternalErrorException, GroupNotAdminException {\n+  try {\n+   if (0 == jdbc.update(\"delete from authz where authorized_group_id=? and vo_id=? and role_id=(select id from roles where name=?)\", group.getId(), vo.getId(), Role.VOADMIN.getRoleName())) {\n+    throw new GroupNotAdminException(\"Group id=\" + group.getId() + \" is not admin of the vo \" + vo);\n+   }\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ @Override\n+ public void removeAdmin(PerunSession sess, SecurityTeam securityTeam, User user) throws UserNotAdminException, InternalErrorException {\n+  try {\n+   if (0 == jdbc.update(\"delete from authz where user_id=? and security_team_id=? and role_id=(select id from roles where name=?)\", user.getId(), securityTeam.getId(), Role.SECURITYADMIN.getRoleName())) {\n+    throw new UserNotAdminException(\"User id=\" + user.getId() + \" is not admin of the security team \" + securityTeam);\n+   }\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ @Override\n+ public void removeAdmin(PerunSession sess, SecurityTeam securityTeam, Group group) throws GroupNotAdminException, InternalErrorException {\n+  try {\n+   if (0 == jdbc.update(\"delete from authz where authorized_group_id=? and security_team_id=? and role_id=(select id from roles where name=?)\", group.getId(), securityTeam.getId(), Role.SECURITYADMIN.getRoleName())) {\n+    throw new GroupNotAdminException(\"Group id=\" + group.getId() + \" is not admin of the security team \" + securityTeam);\n+   }\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void makeUserPerunAdmin(PerunSession sess, User user) throws InternalErrorException {\n+  try {\n+   jdbc.update(\"insert into authz (user_id, role_id) values (?, (select id from roles where name=?))\", user.getId(), Role.PERUNADMIN.getRoleName());\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void removePerunAdmin(PerunSession sess, User user) throws InternalErrorException, UserNotAdminException {\n+  try {\n+   if (0 == jdbc.update(\"delete from authz where user_id=? and role_id=(select id from roles where name=?)\", user.getId(), Role.PERUNADMIN.getRoleName())) {\n+    throw new UserNotAdminException(\"User id=\" + user.getId() + \" is not perun admin.\");\n+   }\n+  } catch (RuntimeException e) {\n+   throw new InternalErrorException(e);\n+  }\n+ }\n+\n+ public void setPerun(Perun perun) {\n+  this.perun = perun;\n+ }\n+\n+}\n\\ No newline at end of file\n",
            "diff_size": 549
        },
        {
            "tool": "styler_random",
            "errors": [],
            "diff": "diff --git a/home/fernanda/mnt/fernanda/git-styler/styler/python/experiments/results/CESNET-perun/errored/1/507/AuthzResolverImpl.java b/home/fernanda/mnt/fernanda/git-styler/styler/python/experiments/results/CESNET-perun/styler_random/507/AuthzResolverImpl.java\nindex ca195b2458a..1aa907b3e61 100644\n--- a/home/fernanda/mnt/fernanda/git-styler/styler/python/experiments/results/CESNET-perun/errored/1/507/AuthzResolverImpl.java\n+++ b/home/fernanda/mnt/fernanda/git-styler/styler/python/experiments/results/CESNET-perun/styler_random/507/AuthzResolverImpl.java\n@@ -140,8 +140,7 @@ public class AuthzResolverImpl implements AuthzResolverImplApi {\n \n \t\t\t\t// Get service users for user\n \t\t\t\tList<Integer> authzServiceUsers = jdbc.query(\"select specific_user_users.specific_user_id as id from users, \" +\n-\t\t\t\t\t\t\"specific_user_users where users.id=specific_user_users.user_id and specific_user_users.status='0' and users.id=? \" +\n-\t\t\t\t        \"and specific_user_users.type=?\", Utils.ID_MAPPER ,user.getId(), SpecificUserType.SERVICE.getSpecificUserType());\n+\t\t\t\t\t\t\"specific_user_users where users.id=specific_user_users.user_id and specific_user_users.status='0' and users.id=? \" +  \"and specific_user_users.type=?\", Utils.ID_MAPPER ,user.getId(), SpecificUserType.SERVICE.getSpecificUserType());\n \t\t\t\tfor (Integer serviceUserId : authzServiceUsers) {\n \t\t\t\t\tauthzRoles.putAuthzRole(Role.SELF, User.class, serviceUserId);\n \t\t\t\t}\n",
            "diff_size": 2
        },
        {
            "tool": "styler_three_grams",
            "errors": [],
            "diff": "diff --git a/home/fernanda/mnt/fernanda/git-styler/styler/python/experiments/results/CESNET-perun/errored/1/507/AuthzResolverImpl.java b/home/fernanda/mnt/fernanda/git-styler/styler/python/experiments/results/CESNET-perun/styler_three_grams/507/AuthzResolverImpl.java\nindex ca195b2458a..40d1612aeee 100644\n--- a/home/fernanda/mnt/fernanda/git-styler/styler/python/experiments/results/CESNET-perun/errored/1/507/AuthzResolverImpl.java\n+++ b/home/fernanda/mnt/fernanda/git-styler/styler/python/experiments/results/CESNET-perun/styler_three_grams/507/AuthzResolverImpl.java\n@@ -141,7 +141,7 @@ public class AuthzResolverImpl implements AuthzResolverImplApi {\n \t\t\t\t// Get service users for user\n \t\t\t\tList<Integer> authzServiceUsers = jdbc.query(\"select specific_user_users.specific_user_id as id from users, \" +\n \t\t\t\t\t\t\"specific_user_users where users.id=specific_user_users.user_id and specific_user_users.status='0' and users.id=? \" +\n-\t\t\t\t        \"and specific_user_users.type=?\", Utils.ID_MAPPER ,user.getId(), SpecificUserType.SERVICE.getSpecificUserType());\n+\t\t\t\t\t\t\t\t\"and specific_user_users.type=?\", Utils.ID_MAPPER ,user.getId(), SpecificUserType.SERVICE.getSpecificUserType());\n \t\t\t\tfor (Integer serviceUserId : authzServiceUsers) {\n \t\t\t\t\tauthzRoles.putAuthzRole(Role.SELF, User.class, serviceUserId);\n \t\t\t\t}\n",
            "diff_size": 1
        }
    ],
    "repaired_by": [
        "styler",
        "intellij",
        "codebuff",
        "styler_random",
        "styler_three_grams"
    ],
    "not_repaired_by": [
        "naturalize"
    ]
}